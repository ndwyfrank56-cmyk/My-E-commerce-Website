<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Checkout - eMarket</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/global-loading.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/loading.css', v='29') }}">
  <!-- Pure OpenStreetMap - No Leaflet -->
  <style>
    :root {
      --bg: #0b0c10;
      --panel: #0e1117;
      --panel-2: #11151d;
      --border: #202431;
      --text-primary: #e8eaee;
      --text-secondary: #9aa3b2;
      --text-light: #7d8697;
      --accent:  #e8eaee; /* metallic gold */
      --accent-hover:  #e8eaee;
      --danger: #b54747;
      --danger-hover: #9e3d3d;
      --border-radius: 10px;
      --transition: all 0.25s ease;
    }

    * { 
      box-sizing: border-box; 
      -webkit-tap-highlight-color: transparent;
      -webkit-touch-callout: none;
    }
    body {
      margin: 0;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      color: var(--text-primary);
      background: var(--bg);
    }

    /* Navbar (match viewall.html) */
    .navbar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1004;
      background: var(--panel);
      border-bottom: none;
    }
    .navbar-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 1rem 2rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
    }
    .navbar-top,
    .navbar-bottom { border-bottom: none; }
    .navbar-top .navbar-container { padding: 0.75rem 2rem; }
    .navbar-bottom .navbar-container { padding: 0.6rem 2rem; gap: 1rem; }
    .logo {
      font-weight: 800;
      letter-spacing: 0.02em;
      color: var(--accent);
      text-decoration: none;
      font-size: 1.4rem;
    }
    .logo .logo-cart { position: relative; top: 1px; font-size: 0.95em; margin: 0 .08em; color: var(--accent); }
    .nav-center { flex: 1; display: flex; justify-content: center; }
    .search-container { position: relative; width: 100%; max-width: 520px; }
    .search-container .search-icon { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--text-secondary); transition: all 0.5s linear; z-index: 10; }
    .search-input { 
      width: 100%; 
      padding: 0.8rem 1rem 0.8rem 2.8rem; 
      background: var(--panel-2); 
      border: none; 
      border-radius: 8px; 
      color: var(--text-primary);
      transition: all 0.25s linear;
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
    }
    .search-input:focus { 
      outline: none; 
      box-shadow: 0 0 0 2px rgba(199,169,106,0.15);
      animation: searchExpand 0.5s linear forwards;
    }
    .search-input::placeholder {
      color: var(--text-secondary);
      transition: opacity 0.25s linear;
    }
    .search-input:focus::placeholder {
      opacity: 0;
    }
    @keyframes searchExpand {
      0% {
        border-radius: 8px;
        padding: 0.8rem 1rem 0.8rem 2.8rem;
      }
      100% {
        border-radius: 8px;
        padding: 0.8rem 1rem 0.8rem 2.8rem;
      }
    }
    .nav-actions { display: flex; align-items: center; gap: 0.75rem; }
    .nav-btn {
      position: relative;
      padding: 0.55rem;
      border: 1px solid rgba(255,255,255,0.12);
      background: var(--panel-2);
      border-radius: 10px;
      cursor: pointer;
      color: var(--text-secondary);
      font-size: 1.1rem;
      transition: background .2s ease, border-color .2s ease, color .2s ease;
      box-shadow: none;
    }
    .nav-btn.profile {
      width: 40px;
      height: 40px;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      border: 2px solid var(--accent);
    }
    .nav-btn.wishlist {
      border: none;
      background: transparent;
      padding: 0.55rem;
      color: var(--text-secondary);
      font-size: 1.2rem;
      position: relative;
      text-decoration: none;
    }
    .nav-btn.wishlist i { color: #d1d5db; }
    .nav-btn.wishlist:hover i { color: #f3f4f6; }
    .nav-btn.cart {
      border: none;
      background: transparent;
    }
    svg{
      height: 30px;
      width: 50px;
    }
    .cart-badge {
      position: absolute;
      top: -6px;
      right: -6px;
      background: var(--accent);
      color: #111318;
      border: 1px solid var(--border);
      border-radius: 50%;
      width: 22px;
      height: 22px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      font-weight: 700;
      box-shadow: 0 0 0 1px rgba(0,0,0,0.35), 0 6px 14px rgba(199,169,106,0.25);
    }

    .wishlist-badge {
      position: absolute;
      top: -6px;
      right: -6px;
      background: #d1d5db;
      color: #111318;
      border: 1px solid #9ca3af;
      border-radius: 50%;
      width: 22px;
      height: 22px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      font-weight: 700;
      box-shadow: 0 0 0 1px rgba(0,0,0,0.35), 0 6px 14px rgba(0,0,0,0.25);
    }
    .menu-btn { display: flex; flex-direction: column; gap: 4px; padding: 0.5rem; background: transparent; border: none; cursor: pointer; }
    .user-welcome {
      color: var(--text-secondary);
      font-size: 0.9rem;
      font-weight: 500;
      margin-right: 0.75rem;
    }

    /* Left Category Sidebar: professional styling (match home.html exactly) */
    .sidebar {
      position: fixed;
      top: 0;
      height: 100vh;
      background: var(--panel);
      border: 1px solid var(--border);
      box-shadow: none;
      transition: transform 0.25s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      z-index: 2300;
      box-sizing: border-box;
    }

    #leftSidebar .sidebar-header {
      padding: 1.5rem 1.25rem;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      background: transparent;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    #leftSidebar .sidebar-title {
      font-size: 0.95rem;
      font-weight: 700;
      color: rgba(255,255,255,0.9);
      letter-spacing: 0.05em;
      text-transform: none;
      margin: 0;
    }

    #leftSidebar .close-btn {
      width: 32px;
      height: 32px;
      border: none;
      background: transparent;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s ease;
      color: #9ca3af;
      font-size: 1.1rem;
      padding: 0;
    }

    #leftSidebar .close-btn:hover {
      background: transparent;
      color: #9ca3af;
      transform: none;
    }

    #leftSidebar .sidebar-content,
    #leftSidebar .sidebar-scrollable { 
      width: 100% !important; 
      box-sizing: border-box; 
    }
    
    #leftSidebar .sidebar-content { 
      padding: 0 !important; 
      position: relative;
      display: flex;
      flex-direction: column;
      height: calc(100vh - 80px);
    }
    
    /* Pixel grid overlay for sidebar */
    #leftSidebar .sidebar-content::after {
      content: "";
      position: absolute;
      inset: 0;
      z-index: 0;
      pointer-events: none;
      opacity: .04;
      background-image: linear-gradient(var(--border) 1px, transparent 1px),
                        linear-gradient(90deg, var(--border) 1px, transparent 1px);
      background-size: 8px 8px;
      background-position: top left;
    }
    
    #leftSidebar .sidebar-scrollable { 
      padding: 0.75rem 1rem !important; 
      position: relative;
      z-index: 1;
      flex: 1;
      overflow-y: auto;
      padding-bottom: 20px;
      /* Hide scrollbars */
      scrollbar-width: none;
      -ms-overflow-style: none;
    }
    
    #leftSidebar .sidebar-scrollable::-webkit-scrollbar { 
      width: 0; 
      height: 0; 
    }

    #leftSidebar .category-list {
      display: flex; 
      flex-direction: column; 
      gap: 0.25rem;
      list-style: none; 
      padding: 0; 
      margin: 0;
      background: transparent;
    }

    /* Clean Category Links - Simple Design */
    #leftSidebar .category-link {
      position: relative;
      display: flex; 
      align-items: center; 
      gap: 0.75rem;
      padding: 0.75rem 1rem;
      border-radius: 6px;
      font-size: 0.875rem; 
      font-weight: 500;
      color: rgba(255,255,255,0.7);
      background: transparent;
      text-decoration: none;
      transition: all 0.2s ease;
    }
    
    #leftSidebar .category-link:hover {
      background: rgba(255,255,255,0.05);
      color: rgba(255,255,255,0.9);
    }

    #leftSidebar .category-link.active { 
      color: rgba(255,255,255,1); 
      background: rgba(255,255,255,0.1); 
      font-weight: 600;
    }

    #leftSidebar .category-icon { 
      width: 18px; 
      height: 18px;
      color: rgba(255,255,255,0.6); 
      font-size: 1rem;
    }
    
    #leftSidebar .category-link.active .category-icon { 
      color: rgba(255,255,255,1); 
    }
    
    #leftSidebar .category-link:hover .category-icon {
      color: rgba(255,255,255,0.9);
    }

    .sidebar-left {
      left: 0;
      transform: translateX(-100%);
      width: 80%;
      max-width: 320px;
    }

    .sidebar-left.active {
      transform: translateX(0);
    }


/* Offset content for fixed navbar */
body { padding-top: 120px; }

/* Layout */
.container { max-width: 800px; margin: 1.5rem auto 2rem; padding: 0 1.5rem; display: grid; grid-template-columns: 1fr; grid-template-rows: auto auto; gap: 2rem; align-items: start; overflow: visible; }

    .card { background: var(--panel); border: 1px solid var(--border); border-radius: 10px; padding: 1.5rem; }
    
    /* Order Summary Card - On top */
    .container > aside {
      grid-column: 1;
      grid-row: 1;
      align-self: start;
      padding: 1rem;
      width: 100%;
      box-sizing: border-box;
    }
    
    /* Form Card - Below */
    .container > section {
      grid-column: 1;
      grid-row: 2;
      width: 100%;
      box-sizing: border-box;
    }
    
    /* Order Items - Natural Flow */
    .order-items {
      width: 100%;
    }
    
    .order-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.5rem 0;
      margin-bottom: 0.5rem;
      border-bottom: 1px solid rgba(255,255,255,0.05);
      width: 100%;
    }
    
    .order-thumb {
      width: 50px;
      height: 50px;
      border-radius: 6px;
      overflow: hidden;
      flex-shrink: 0;
    }
    
    .order-thumb img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .order-info {
      flex: 1;
      min-width: 0;
      overflow: hidden;
    }
    
    .order-name {
      font-size: 0.9rem;
      font-weight: 600;
      margin-bottom: 0.25rem;
      line-height: 1.3;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .order-meta {
      font-size: 0.75rem;
      color: var(--text-light);
    }
    
    .order-price {
      font-weight: 600;
      font-size: 0.9rem;
      color: var(--text-primary);
      white-space: nowrap;
    }
    
    /* Compact Cost Breakdown */
    .cost-breakdown {
      margin-top: 1rem !important;
      padding-top: 1rem !important;
      width: 100%;
      overflow-x: hidden;
    }
    
    .cost-row {
      margin-bottom: 0.4rem !important;
      font-size: 0.9rem;
    }
    
    .total-row {
      font-size: 1rem !important;
      font-weight: 700 !important;
      margin-top: 0.75rem !important;
      padding-top: 0.75rem !important;
      border-top: 1px solid rgba(255,255,255,0.15) !important;
    }
    
    /* Location Section - Mobile Responsive */
    .location-section {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      align-items: flex-start;
    }
    
    .location-btn {
      padding: 0.65rem 1.2rem;
      font-size: 0.9rem;
      background: rgba(229, 231, 235, 0.2);
      color: rgba(229, 231, 235, 0.9);
      border: 1px solid rgba(229, 231, 235, 0.3);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
      white-space: nowrap;
    }
    
    .location-btn:hover {
      background: rgba(229, 231, 235, 0.3);
    }
    
    .location-btn i {
      margin-right: 0.5rem;
    }
    
    .location-privacy-note {
      display: flex;
      align-items: center;
      gap: 0.4rem;
      color: var(--text-light);
      font-size: 0.8rem;
      line-height: 1.3;
      flex-wrap: wrap;
    }
    
    .location-privacy-note i {
      color: rgba(229, 231, 235, 0.6);
      flex-shrink: 0;
    }
    
    .privacy-text {
      font-weight: 600;
      white-space: nowrap;
    }
    
    .privacy-detail {
      opacity: 0.8;
    }
    
    /* Mobile Responsive for Location Section */
    @media (max-width: 768px) {
      .location-section {
        gap: 0.5rem;
      }
      
      .location-btn {
        width: 100%;
        justify-content: center;
        display: flex;
        align-items: center;
      }
      
      .location-privacy-note {
        font-size: 0.75rem;
        text-align: center;
        justify-content: center;
        gap: 0.3rem;
      }
      
      .privacy-detail {
        display: block;
        width: 100%;
        text-align: center;
        margin-top: 0.2rem;
      }
    }
    .card h2 { margin: 0 0 1rem; font-size: 1.25rem; font-weight: 800; text-transform: uppercase; letter-spacing: 0.04em; color: var(--text-primary); }

    .split { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
    .form { display: grid; gap: 1rem; }
    .form-row { display: grid; gap: 0.5rem; position: relative; margin-bottom: 1.5rem; }
    label { color: #888888; font-weight: 500; font-size: 0.85rem; margin-bottom: 0.5rem; }
    input, select, textarea { padding: 1rem 0; background: transparent; border: none; border-bottom: 1px solid #444444; border-radius: 0; color: var(--text-primary); outline: none; font-size: 1.1rem; transition: none; }
    textarea { min-height: 100px; resize: vertical; border: 1px solid #444444; border-radius: 8px; padding: 1rem; }
    input:focus, select:focus { border-bottom-color: rgba(255,255,255,0.5); }
    textarea:focus { border-color: rgba(255,255,255,0.5); }
    input::placeholder, textarea::placeholder { color: #666666; }
    /* Pay Now Button - Clean, Professional & Seductive */
    .pay-btn {
      width: 100% !important;
      padding: 1.1rem 1.5rem !important;
      background: #2e7d32 !important;
      color: #ffffff !important;
      border: none !important;
      border-radius: 8px !important;
      font-weight: 700 !important;
      font-size: 1rem !important;
      letter-spacing: 0.02em !important;
      cursor: pointer !important;
      transition: all 0.25s ease !important;
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
      gap: 0.6rem !important;
      position: relative !important;
      overflow: hidden !important;
      box-shadow: 0 4px 12px rgba(46, 125, 50, 0.25) !important;
    }

    .pay-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: rgba(255,255,255,0.1);
      transition: left 0.4s ease;
    }

    .pay-btn:hover {
      background: #2e7d32 !important;
      box-shadow: 0 4px 12px rgba(46, 125, 50, 0.25) !important;
      transform: none !important;
    }

    .pay-btn:hover::before {
      left: -100%;
    }

    .pay-btn:active {
      transform: none !important;
      box-shadow: 0 4px 12px rgba(46, 125, 50, 0.25) !important;
    }

    .pay-btn img {
      height: 20px !important;
      width: auto !important;
      filter: brightness(0) invert(1);
      margin-right: 0 !important;
    }

    .pay-btn i {
      font-size: 1.1rem !important;
    }

    /* Order Summary */
    .order-items { display: flex; flex-direction: column; gap: 0.75rem; }
    .order-item { display: flex; gap: 0.75rem; align-items: center; padding-bottom: 0.75rem; border-bottom: 1px solid #222; }
    .order-item:last-child { border-bottom: none; }
    .order-thumb { width: 50px; height: 50px; border-radius: 6px; overflow: hidden; flex-shrink: 0; background: rgba(255,255,255,0.05); }
    .order-thumb img { width: 100%; height: 100%; object-fit: cover; }
    .order-info { flex: 1; }
    .order-name { font-weight: 600; margin-bottom: 0.25rem; color: var(--text-primary); font-size: 0.9rem; }
    .order-meta { color: #888888; font-size: 0.8rem; }
    .order-variations { color: #888888; font-size: 0.75rem; margin-top: 0.15rem; }
    .order-price { font-weight: 700; color: var(--text-primary); font-size: 0.9rem; }
    .order-price { font-weight: 800; color: var(--accent); }
    .total { margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border); display: flex; justify-content: space-between; font-weight: 900; font-size: 1.1rem; }

    .empty { text-align: center; color: var(--text-secondary); padding: 2rem 0; }

    /* Flash messages */
    .flash-container { grid-column: 1 / -1; }
    .flash { margin: 0 0 1rem; padding: 0.9rem 1rem; border-radius: 8px; border: 1px solid var(--border); background: var(--panel); font-weight: 600; }
    .flash-error { display: none; border-color: #7a2e2e; background: #2a1c1c; color: #f2b8b8; }
    .flash-success { border-color: #3b6b3b; background: #1b2a1b; color: #b8f2b8; }
    .flash-info { border-color: #2e4b7a; background: #1c1f2a; color: #b8c8f2; }

    .search-dropdown {
      position: fixed;
      top: auto;
      left: 50%;
      transform: translateX(-50%);
      background: var(--panel-2);
      border-radius: 10px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
      max-height: 400px;
      overflow-y: auto;
      z-index: 9999;
      display: none;
      border: 1px solid var(--border);
      width: 90vw;
      max-width: 1000px;
    }

    .search-dropdown.active {
      display: block;
    }

    .search-result-item {
      padding: 12px 14px;
      border-bottom: 1px solid var(--border);
      cursor: pointer;
      transition: background 0.2s ease;
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .search-result-item:last-child {
      border-bottom: none;
    }

    .search-result-item:hover {
      background: rgba(255, 255, 255, 0.08);
    }

    .search-result-item img {
      width: 48px;
      height: 48px;
      object-fit: cover;
      border-radius: 6px;
      flex-shrink: 0;
    }

    .search-result-info {
      flex: 1;
      min-width: 0;
    }

    .search-result-name {
      font-weight: 600;
      color: var(--text-primary);
      font-size: 14px;
      margin-bottom: 4px;
      overflow: visible;
      text-overflow: clip;
      white-space: normal;
      word-break: break-word;
    }

    .search-result-price {
      color: var(--text-secondary);
      font-size: 13px;
      font-weight: 500;
    }

    .search-no-results {
      padding: 20px;
      text-align: center;
      color: var(--text-secondary);
      font-size: 14px;
    }

    @media (max-width: 900px) {
      .container { 
        padding: 0 1rem;
        gap: 1.5rem;
      }
      
      .split { grid-template-columns: 1fr; }
      #map { height: 260px; }
      
      .card {
        padding: 1.25rem;
      }
    }
    
    @media (max-width: 768px) {
      body { padding-top: 120px; }
      
      .navbar-container {
        padding: 0.75rem 1rem;
        flex-wrap: wrap;
        gap: 0.5rem;
      }
      
      .navbar-top .navbar-container {
        padding: 0.65rem 1rem;
      }
      
      .navbar-bottom .navbar-container {
        padding: 0.55rem 1rem;
      }
      
      .logo {
        font-size: 1.2rem;
        flex-shrink: 0;
      }
      
      .search-container {
        max-width: 300px;
        flex: 1;
        min-width: 200px;
      }
      
      .search-input {
        padding: 0.6rem 0.8rem 0.6rem 2.2rem;
        font-size: 0.85rem;
      }
      
      .nav-actions {
        flex-shrink: 0;
        gap: 0.3rem;
      }
      
      .nav-btn {
        padding: 0.4rem;
        font-size: 1rem;
      }
      
      .nav-btn.profile {
        width: 36px;
        height: 36px;
      }
      
      .nav-btn.wishlist {
        font-size: 1rem;
      }
      
      .container {
        padding: 0 0.75rem;
        margin: 1rem auto 1.5rem;
        gap: 1.25rem;
      }
      
      .card {
        padding: 1rem;
        border-radius: 8px;
      }
      
      h2 {
        font-size: 1.25rem;
      }
      
      label {
        font-size: 0.9rem;
      }
      
      input, select, textarea {
        font-size: 0.9rem;
        padding: 0.7rem 1rem;
      }
      
      button {
        font-size: 0.9rem;
        padding: 0.8rem 1.25rem;
      }
      
      .order-thumb {
        width: 45px;
        height: 45px;
      }
      
      .order-name {
        font-size: 0.85rem;
      }
      
      .order-meta {
        font-size: 0.7rem;
      }
      
      .order-price {
        font-size: 0.85rem;
      }
      
      /* Order summary card styling for mobile */
      .container > aside {
        margin-bottom: 0;
      }
      
      .order-items {
        gap: 0.5rem;
      }
      
      .order-item {
        padding-bottom: 0.5rem;
        gap: 0.5rem;
      }
      
      .total {
        margin-top: 1rem !important;
        padding-top: 1rem !important;
      }
    }
    
    @media (max-width: 600px) {
      #map { height: 240px; }
      
      .container {
        padding: 0 0.65rem;
        gap: 1rem;
      }
      
      .card {
        padding: 0.85rem;
      }
      
      h2 {
        font-size: 1.1rem;
      }
      
      .split {
        gap: 0.75rem;
      }
      
      .form-row {
        margin-bottom: 1.25rem;
        gap: 0.4rem;
      }
      
      label {
        font-size: 0.8rem;
        margin-bottom: 0.4rem;
      }
    }
    
    @media (max-width: 480px) {
      body { padding-top: 150px; }
      
      .navbar-container {
        padding: 0.5rem 0.75rem;
      }
      
      .navbar-top .navbar-container {
        padding: 0.5rem 0.75rem;
      }
      
      .navbar-bottom .navbar-container {
        padding: 0.45rem 0.75rem;
      }
      
      .logo {
        font-size: 1.2rem;
      }
      
      .search-container {
        max-width: 100%;
      }
      
      .search-input {
        padding: 0.6rem 0.75rem 0.6rem 2.25rem;
        font-size: 0.85rem;
      }
      
      .search-container .search-icon {
        left: 0.75rem;
        font-size: 0.9rem;
      }
      
      .nav-btn {
        padding: 0.4rem;
        font-size: 0.95rem;
      }
      
      .nav-btn.profile {
        width: 32px;
        height: 32px;
      }
      
      .nav-btn.wishlist {
        font-size: 0.95rem;
      }
      
      .nav-actions {
        gap: 0.5rem;
      }
      
      #map { height: 220px; }
      
      .container {
        padding: 0 0.75rem;
        margin: 0.75rem auto 1rem;
        gap: 1rem;
      }
      
      .card {
        padding: 0.85rem;
        border-radius: 6px;
      }
      
      h2 {
        font-size: 1rem;
        margin-bottom: 0.75rem;
      }
      
      .form-row {
        margin-bottom: 1rem;
        gap: 0.35rem;
      }
      
      .split {
        gap: 0.5rem;
      }
      
      label {
        font-size: 0.75rem;
        margin-bottom: 0.35rem;
      }
      
      input, select, textarea {
        font-size: 0.8rem;
        padding: 0.6rem 0;
      }
      
      textarea {
        padding: 0.6rem;
        min-height: 80px;
      }
      
      button {
        font-size: 0.85rem;
        padding: 0.7rem 1rem;
      }
      
      .pay-btn {
        padding: 0.6rem 1rem !important;
        font-size: 0.85rem !important;
      }
      
      .section-content {
        margin-bottom: 1rem;
      }
      
      .order-thumb {
        width: 40px;
        height: 40px;
        border-radius: 5px;
      }
      
      .order-item {
        padding: 0.4rem 0;
        margin-bottom: 0.4rem;
        gap: 0.6rem;
      }
      
      .order-name {
        font-size: 0.75rem;
        margin-bottom: 0.2rem;
      }
      
      .order-meta {
        font-size: 0.6rem;
      }
      
      .order-price {
        font-size: 0.75rem;
      }
      
      .cost-breakdown {
        margin-top: 0.75rem !important;
        padding-top: 0.75rem !important;
      }
      
      .cost-row {
        font-size: 0.8rem;
        margin-bottom: 0.35rem !important;
      }
      
      .total-row {
        font-size: 0.9rem !important;
        margin-top: 0.6rem !important;
        padding-top: 0.6rem !important;
      }
    }
    
    @media (max-width: 390px) {
      body { padding-top: 155px; }
      
      .navbar-container {
        padding: 0.45rem 0.5rem;
      }
      
      .logo {
        font-size: 1.1rem;
      }
      
      .search-input {
        padding: 0.55rem 0.65rem 0.55rem 2rem;
        font-size: 0.8rem;
      }
      
      .search-container .search-icon {
        left: 0.65rem;
        font-size: 0.85rem;
      }
      
      .nav-btn {
        padding: 0.35rem;
        font-size: 0.9rem;
      }
      
      .nav-btn.profile {
        width: 30px;
        height: 30px;
      }
      
      .nav-actions {
        gap: 0.4rem;
      }
      
      #map { height: 200px; }
      
      .container {
        padding: 0 0.6rem;
        margin: 0.5rem auto 0.75rem;
        gap: 0.75rem;
      }
      
      .card {
        padding: 0.7rem;
        border-radius: 5px;
      }
      
      h2 {
        font-size: 0.9rem;
        margin-bottom: 0.6rem;
      }
      
      .form-row {
        margin-bottom: 0.85rem;
        gap: 0.3rem;
      }
      
      .split {
        gap: 0.4rem;
      }
      
      label {
        font-size: 0.7rem;
        margin-bottom: 0.3rem;
      }
      
      input, select, textarea {
        font-size: 0.75rem;
        padding: 0.55rem 0;
      }
      
      textarea {
        padding: 0.55rem;
        min-height: 70px;
      }
      
      button {
        font-size: 0.75rem;
        padding: 0.6rem 0.85rem;
      }
      
      .pay-btn {
        padding: 0.55rem 0.9rem !important;
        font-size: 0.8rem !important;
      }
      
      .section-content {
        margin-bottom: 0.75rem;
      }
      
      .order-thumb {
        width: 32px;
        height: 32px;
        border-radius: 4px;
      }
      
      .order-item {
        padding: 0.35rem 0;
        margin-bottom: 0.35rem;
        gap: 0.5rem;
      }
      
      .order-name {
        font-size: 0.7rem;
        margin-bottom: 0.15rem;
        line-height: 1.2;
      }
      
      .order-meta {
        font-size: 0.55rem;
      }
      
      .order-price {
        font-size: 0.7rem;
      }
      
      .cost-breakdown {
        margin-top: 0.6rem !important;
        padding-top: 0.6rem !important;
      }
      
      .cost-row {
        font-size: 0.75rem;
        margin-bottom: 0.3rem !important;
      }
      
      .total-row {
        font-size: 0.85rem !important;
        margin-top: 0.5rem !important;
        padding-top: 0.5rem !important;
      }
    }


    /* Scroll-triggered animations */
    .scroll-animate {
      opacity: 0;
      transform: translateY(30px);
      transition: opacity 0.6s ease, transform 0.6s ease;
    }
    .scroll-animate.animate-in {
      opacity: 1;
      transform: translateY(0);
    }
    .container.scroll-animate {
      transform: translateY(20px) scale(0.98);
    }
    .container.scroll-animate.animate-in {
      transform: translateY(0) scale(1);
    }
    .card.scroll-animate {
      transform: rotateY(-5deg) translateY(20px);
    }
    .card.scroll-animate.animate-in {
      transform: rotateY(0deg) translateY(0);
    }
    .order-item.scroll-animate {
      transform: translateX(30px);
    }
    .order-item.scroll-animate.animate-in {
      transform: translateX(0);
    }
    .total.scroll-animate {
      transform: translateY(20px);
    }
    .total.scroll-animate.animate-in {
      transform: translateY(0);
    }
    .flash.scroll-animate {
      transform: translateY(-20px);
    }
    .flash.scroll-animate.animate-in {
      transform: translateY(0);
    }

    /* MoMo Modal */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background: rgba(0,0,0,0.6);
    }
    .modal-content {
      background: var(--panel);
      margin: 15% auto;
      padding: 2rem;
      border: 1px solid var(--border);
      border-radius: 12px;
      width: 90%;
      max-width: 400px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }
    .modal-header h3 {
      margin: 0;
      color: var(--text-primary);
      font-size: 1.25rem;
    }
    .modal-close {
      color: var(--text-secondary);
      font-size: 28px;
      font-weight: bold;
      background: none;
      border: none;
      cursor: pointer;
    }
    .modal-close:hover,
    .modal-close:focus {
      color: var(--text-primary);
    }

    /* Map Styling - Pure OpenStreetMap iframe */
    #map {
      width: 100%;
      height: 280px;
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid var(--border);
      margin: 1rem 0;
      background: var(--panel-2);
      position: relative;
      z-index: 1;
    }
    
    #map iframe {
      width: 100%;
      height: 100%;
      border: none;
      border-radius: 12px;
      display: block;
    }

    /* Payment Status Modal */
    .payment-modal {
      display: none;
      position: fixed;
      z-index: 2000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background: rgba(0,0,0,0.8);
      animation: fadeIn 0.3s ease;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    .payment-modal-content {
      background: var(--panel);
      margin: 10% auto;
      padding: 2.5rem;
      border: 1px solid var(--border);
      border-radius: 16px;
      width: 90%;
      max-width: 450px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.5);
      animation: slideUp 0.4s ease;
      text-align: center;
    }
    @keyframes slideUp {
      from { transform: translateY(50px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    .payment-icon {
      width: 80px;
      height: 80px;
      margin: 0 auto 1.5rem;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2.5rem;
    }
    .payment-icon.pending {
      background: rgba(199,169,106,0.15);
      color: var(--accent);
      animation: pulse 1.5s ease-in-out infinite;
    }
    .payment-icon.success {
      background: rgba(59,107,59,0.2);
      color: #6fd66f;
    }
    .payment-icon.failed {
      background: rgba(181,71,71,0.2);
      color: #f27c7c;
    }
    @keyframes pulse {
      0%, 100% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.05); opacity: 0.8; }
    }
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    .payment-title {
      font-size: 1.5rem;
      font-weight: 800;
      margin-bottom: 0.75rem;
      color: var(--text-primary);
    }
    .payment-message {
      color: var(--text-secondary);
      font-size: 1rem;
      line-height: 1.6;
      margin-bottom: 2rem;
    }
    .payment-actions {
      display: flex;
      gap: 1rem;
      justify-content: center;
    }
    .modal-btn {
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s ease;
      border: none;
      font-size: 0.95rem;
    }
    .modal-btn-primary {
      background: rgba(255, 255, 255, 0.15);
      color: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
    }
    .modal-btn-secondary {
      background: var(--panel-2);
      color: var(--text-primary);
      border: 1px solid var(--border);
    }
    .modal-btn-secondary:hover {
      background: #202632;
    }
    .spinner {
      animation: spin 1s linear infinite;
    }
    .hidden { 
      display: none !important; 
      visibility: hidden !important;
    }
    
    .cod-btn {
      padding: 0.7rem 1.2rem;
      background: rgba(255, 255, 255, 0.15);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      padding: 0.75rem 1.125rem;
      background: rgba(255, 255, 255, 0.95);
      color: #0a0d12;
      font-weight: 500;
      font-size: 0.85rem;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      text-transform: none;
      letter-spacing: 0px;
    }
    .btn-view-cart {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0.75rem 1.125rem;
      color: rgba(255, 255, 255, 0.8);
      font-size: 0.85rem;
      font-weight: 500;
      text-decoration: none;
      background: rgba(255, 255, 255, 0.08);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 6px;
    }

    /* COD Success Modal - Floating and Prominent */
    .cod-success-modal {
      display: none;
      position: fixed;
      z-index: 3000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background: rgba(0,0,0,0.85);
      animation: fadeIn 0.4s ease;
    }
    
    .cod-success-content {
      background: linear-gradient(135deg, #1a1f2e 0%, #0f1419 100%);
      margin: 8% auto;
      padding: 3rem 2.5rem;
      border: 2px solid #2d5a2d;
      border-radius: 20px;
      width: 90%;
      max-width: 500px;
      box-shadow: 
        0 25px 80px rgba(0,0,0,0.7),
        0 0 0 1px rgba(45, 90, 45, 0.3),
        inset 0 1px 0 rgba(255,255,255,0.1);
      animation: slideUpBounce 0.6s ease;
      text-align: center;
      position: relative;
      overflow: hidden;
    }
    
    .cod-success-content::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(45, 90, 45, 0.1), transparent);
      animation: shimmer 2s ease-in-out infinite;
    }
    
    @keyframes slideUpBounce {
      0% { 
        transform: translateY(100px) scale(0.8); 
        opacity: 0; 
      }
      60% { 
        transform: translateY(-10px) scale(1.02); 
        opacity: 1; 
      }
      100% { 
        transform: translateY(0) scale(1); 
        opacity: 1; 
      }
    }
    
    @keyframes shimmer {
      0% { left: -100%; }
      100% { left: 100%; }
    }
    
    .cod-success-icon {
      width: 100px;
      height: 100px;
      margin: 0 auto 2rem;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 3.5rem;
      background: radial-gradient(circle, #2d5a2d 0%, #1a3d1a 100%);
      color: #4ade80;
      box-shadow: 
        0 0 30px rgba(74, 222, 128, 0.3),
        inset 0 2px 0 rgba(255,255,255,0.1),
        inset 0 -2px 0 rgba(0,0,0,0.2);
      animation: successPulse 2s ease-in-out infinite;
      position: relative;
    }
    
    .cod-success-icon::after {
      content: '';
      position: absolute;
      inset: -10px;
      border-radius: 50%;
      background: conic-gradient(from 0deg, transparent, rgba(74, 222, 128, 0.2), transparent);
      animation: rotate 3s linear infinite;
      z-index: -1;
    }
    
    @keyframes successPulse {
      0%, 100% { 
        transform: scale(1); 
        box-shadow: 0 0 30px rgba(74, 222, 128, 0.3);
      }
      50% { 
        transform: scale(1.05); 
        box-shadow: 0 0 40px rgba(74, 222, 128, 0.5);
      }
    }
    
    @keyframes rotate {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    
    .cod-success-title {
      font-size: 2rem;
      font-weight: 800;
      margin-bottom: 1rem;
      color: #4ade80;
      text-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
    
    .cod-success-message {
      color: var(--text-primary);
      font-size: 1.1rem;
      line-height: 1.6;
      margin-bottom: 1.5rem;
      opacity: 0.9;
    }
    
    .cod-order-info {
      background: rgba(45, 90, 45, 0.1);
      border: 1px solid rgba(45, 90, 45, 0.3);
      border-radius: 12px;
      padding: 1.5rem;
      margin: 2rem 0;
      backdrop-filter: blur(10px);
    }
    
    .cod-order-number {
      font-size: 0.9rem;
      color: var(--text-secondary);
      margin-bottom: 0.5rem;
    }
    
    .cod-order-id {
      font-size: 1.5rem;
      font-weight: 800;
      color: #4ade80;
      font-family: 'Courier New', monospace;
      letter-spacing: 2px;
    }
    
    .cod-success-actions {
      display: flex;
      gap: 1rem;
      justify-content: center;
      margin-top: 2rem;
    }
    
    .cod-btn-primary {
      padding: 1rem 2rem;
      background: linear-gradient(135deg, #4ade80 0%, #22c55e 100%);
      color: #0f1419;
      border: none;
      border-radius: 12px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 8px 25px rgba(74, 222, 128, 0.3);
      font-size: 1rem;
    }
    
    .cod-btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 35px rgba(74, 222, 128, 0.4);
      background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
    }
    
    .cod-btn-secondary {
      padding: 1rem 2rem;
      background: transparent;
      color: var(--text-primary);
      border: 2px solid rgba(255,255,255,0.2);
      border-radius: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 1rem;
    }
    
    .cod-btn-secondary:hover {
      border-color: rgba(255,255,255,0.4);
      background: rgba(255,255,255,0.05);
      transform: translateY(-1px);
    }

    /* Skip Location Button */
    .skip-location-btn:hover {
      border-color: rgba(255,255,255,0.3) !important;
      background: rgba(255,255,255,0.05) !important;
      color: var(--text-primary) !important;
      transform: translateY(-1px) !important;
    }

    /* Payment Method Tabs - Like Login/Register */
    .payment-tabs {
      display: flex;
      margin-bottom: 1.5rem;
      gap: 0;
      border-bottom: 1px solid var(--border);
    }

    .payment-tab-btn {
      position: relative;
      flex: 1;
      padding: 1rem 1.5rem;
      background: transparent;
      border: none;
      border-bottom: 2px solid transparent;
      color: var(--text-secondary);
      font-weight: 600;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.2s ease;
      text-align: center;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }

    .payment-tab-btn.active {
      color: var(--text-primary);
      border-bottom-color: rgba(255, 255, 255, 0.8);
      background: rgba(255, 255, 255, 0.05);
    }

    .payment-tab-btn:hover {
      color: var(--text-primary);
      background: rgba(255, 255, 255, 0.03);
    }

    .payment-tab-btn i {
      font-size: 1rem;
      opacity: 0.7;
      transition: all 0.2s ease;
    }

    .payment-tab-btn.active i {
      opacity: 1;
      color: rgba(255,255,255,0.85);
    }

    .payment-tab-btn span {
      font-size: 0.9rem;
      font-weight: 600;
    }

    /* Disabled Payment Tab */
    .payment-tab-btn.disabled {
      opacity: 0.6;
      cursor: not-allowed;
      position: relative;
    }

    .payment-tab-btn.disabled:hover {
      color: var(--text-secondary);
      background: transparent;
    }

    .payment-tab-btn.disabled i {
      opacity: 0.4;
    }

    /* MTN logo inside payment option */
    .payment-option img.payment-logo {
      height: 18px;
      width: auto;
      display: inline-block;
      filter: none !important;
      mix-blend-mode: normal;
      background: none; /* using native yellow PNG */
      border-radius: 4px;
      padding: 0;
    }

    /* Disabled Payment Option */
    .payment-option.disabled {
      opacity: 0.6;
      cursor: not-allowed;
      position: relative;
    }

    .payment-option.disabled:hover {
      border-color: #444444;
      background: transparent;
    }

    .payment-option {
      position: relative;
    }
    
    .coming-soon-badge {
      position: absolute;
      top: -3px;
      right: -1px;
      background: #ff4d4f;
      color: #fff;
      font-size: 0.65rem !important;
      font-weight: 700 !important;
      padding: 0.2rem 0.5rem;
      border-radius: 12px;
      z-index: 10;
    }

    /* Disabled Field Styling */
    .disabled-field {
      position: relative;
    }

    .input-container {
      position: relative;
    }

    .disabled-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: transparent;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      color: #ff4d4f;
      font-size: 0.9rem;
      font-weight: 700;
      border-radius: 4px;
      backdrop-filter: none;
      pointer-events: none;
    }

    .disabled-overlay i {
      color: #ff4d4f;
      font-size: 1.1rem;
    }

    .disabled-overlay span {
      text-transform: uppercase;
      color: inherit;
      letter-spacing: 0.02em;
    }

    /* Payment Action Row - MoMo Number + Buttons Side by Side */
    .payment-action-row {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 1.5rem;
      align-items: end;
      margin-top: 1.5rem;
    }

    .momo-number-field {
      margin: 0;
    }

    .payment-buttons {
      display: flex;
      gap: 1rem;
      align-items: center;
    }

    /* Location Search Results */
    #search_results {
      max-height: 250px;
      overflow-y: auto;
      scrollbar-width: thin;
      scrollbar-color: var(--border) var(--panel-2);
    }
    
    #search_results::-webkit-scrollbar {
      width: 6px;
    }
    
    #search_results::-webkit-scrollbar-track {
      background: var(--panel-2);
    }
    
    #search_results::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 3px;
    }
    
    .search-result-item {
      padding: 0.9rem 1rem;
      border-bottom: 1px solid var(--border);
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: start;
      gap: 0.75rem;
    }
    
    .search-result-item:last-child {
      border-bottom: none;
    }
    
    .search-result-item:hover {
      background: rgba(255,255,255,0.05);
      padding-left: 1.25rem;
    }
    
    .search-result-icon {
      color: var(--accent);
      font-size: 1rem;
      margin-top: 0.2rem;
      flex-shrink: 0;
    }
    
    .search-result-content {
      flex: 1;
    }
    
    .search-result-name {
      color: var(--text-primary);
      font-weight: 600;
      margin-bottom: 0.25rem;
      font-size: 0.95rem;
    }
    
    .search-result-address {
      color: var(--text-secondary);
      font-size: 0.85rem;
      line-height: 1.4;
    }
    
    .search-loading {
      padding: 1rem;
      text-align: center;
      color: var(--text-secondary);
      font-size: 0.9rem;
    }
    
    .search-no-results {
      padding: 1rem;
      text-align: center;
      color: var(--text-secondary);
      font-size: 0.9rem;
    }

    /* Responsive */
    @media (max-width: 768px) {
      label {
        font-size: 1rem !important;
        font-weight: 600 !important;
        margin-bottom: 0.75rem !important;
      }
      
      input, select, textarea {
        font-size: 1.2rem !important;
        padding: 1.2rem 0 !important;
      }
      
      .payment-tabs {
        /* Keep horizontal layout on mobile like desktop */
        flex-direction: row;
        gap: 0;
      }
      
      .payment-tab-btn {
        padding: 0.875rem 1rem;
        font-size: 0.95rem;
        gap: 0.4rem;
      }
      
      .payment-tab-btn i {
        font-size: 1rem;
      }
      
      .payment-tab-btn span {
        font-size: 0.95rem;
      }

      .payment-action-row {
        grid-template-columns: 1fr;
        gap: 1rem;
      }

      .payment-buttons {
        justify-content: center;
      }
    }

    /* Checkout Steps Styles */
    .checkout-steps {
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 1.5rem;
      padding: 0.5rem 0;
      border-bottom: 1px solid var(--border);
    }

    .step {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.5rem;
      opacity: 0.4;
      transition: var(--transition);
    }

    .step.active,
    .step.completed {
      opacity: 1;
    }

    .step-number {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: var(--panel-2);
      border: 2px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 0.8rem;
      color: var(--text-secondary);
      transition: var(--transition);
    }

    .step.active .step-number {
      background: var(--accent);
      border-color: var(--accent);
      color: var(--bg);
    }

    .step.completed .step-number {
      background: rgba(229, 231, 235, 0.85);
      border-color: rgba(229, 231, 235, 0.6);
      color: #000;
    }

    .step-label {
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--text-secondary);
      transition: var(--transition);
    }

    .step.active .step-label,
    .step.completed .step-label {
      color: var(--text-primary);
    }

    .step-connector {
      width: 50px;
      height: 2px;
      background: var(--border);
      margin: 0 0.75rem;
      position: relative;
      top: -8px;
    }

    /* Checkout sections - show all */
    .checkout-section {
      display: block;
      margin-bottom: 2rem;
    }

    @keyframes slideInRight {
      from { 
        opacity: 0;
        transform: translateX(20px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .section-header {
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid var(--border);
    }
    
    .section-header h3 {
      margin: 0;
      font-size: 0.85rem;
      font-weight: 400;
      color: var(--text-primary);
    }


    .section-content {
      margin-bottom: 1.5rem;
    }

    .section-actions {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
      padding-top: 1.5rem;
      border-top: 1px solid var(--border);
    }

    .next-btn,
    .prev-btn {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      font-size: 0.95rem;
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .next-btn {
      background: var(--accent);
      color: var(--bg);
      margin-left: auto;
    }

    .next-btn:hover {
      background: var(--accent-hover);
      transform: translateY(-1px);
    }

    .prev-btn {
      background: transparent;
      border: none;
      color: var(--text-secondary);
    }

    .prev-btn:hover {
      background: transparent;
      color: var(--text-primary);
    }

    @media (max-width: 768px) {
      .checkout-steps {
        padding: 1rem 0;
      }
      
      .step-number {
        width: 35px;
        height: 35px;
        font-size: 0.9rem;
      }
      
      .step-label {
        font-size: 0.8rem;
      }
      
      .step-connector {
        width: 40px;
        margin: 0 0.5rem;
      }
      
      .section-header {
        flex-direction: column;
        text-align: center;
        gap: 0.75rem;
      }
      
      .section-actions {
        flex-direction: column-reverse;
        gap: 0.75rem;
      }
      
      .next-btn,
      .prev-btn {
        width: 100%;
        justify-content: center;
        margin-left: 0;
      }
    }
  </style>
</head>
<body>
  <!-- Global Loading Overlay -->
  <div id="globalLoadingOverlay" class="global-loading-overlay">
    <div class="global-loading-spinner">
      <svg class="cart" role="img" aria-label="Shopping cart line animation" viewBox="0 0 128 128" width="128px" height="128px" xmlns="http://www.w3.org/2000/svg">
        <g fill="none" stroke-linecap="round" stroke-linejoin="round" stroke-width="8">
          <g class="cart__track" stroke="hsla(0,10%,10%,0.1)">
            <polyline points="4,4 21,4 26,22 124,22 112,64 35,64 39,80 106,80" />
            <circle cx="43" cy="111" r="13" />
            <circle cx="102" cy="111" r="13" />
          </g>
          <g class="cart__lines" stroke="currentColor">
            <polyline class="cart__top" points="4,4 21,4 26,22 124,22 112,64 35,64 39,80 106,80" stroke-dasharray="338 338" stroke-dashoffset="-338" />
            <g class="cart__wheel1" transform="rotate(-90,43,111)">
              <circle class="cart__wheel-stroke" cx="43" cy="111" r="13" stroke-dasharray="81.68 81.68" stroke-dashoffset="81.68" />
            </g>
            <g class="cart__wheel2" transform="rotate(90,102,111)">
              <circle class="cart__wheel-stroke" cx="102" cy="111" r="13" stroke-dasharray="81.68 81.68" stroke-dashoffset="81.68" />
            </g>
          </g>
        </g>
      </svg>
    </div>
    <div class="global-loading-text">Processing your order...</div>
    <div class="global-loading-subtext">Securing your checkout experience</div>
  </div>

  <!-- Navbar -->
  <div class="navbar">
    <!-- Top bar: Logo + Profile -->
    <nav class="navbar-top">
      <div class="navbar-container">
        <a href="/" class="logo">eM<i class="fas fa-shopping-cart logo-cart" aria-hidden="true"></i>rket</a>
        <div class="nav-actions">
          <div class="nav-user" style="display:flex;flex-direction:column;align-items:center;gap:4px;">
            <a href="/profile" class="nav-btn profile" title="My Profile"><i class="fas fa-user"></i></a>
            {% if session.user_id %}
              <div class="nav-user-name" style="font-size:0.75rem;color:var(--text-secondary);line-height:1;">{{ session.username }}</div>
            {% endif %}
          </div>
        </div>
      </div>
    </nav>
    <!-- Bottom bar: Hamburger + Search + Cart -->
    <nav class="navbar-bottom">
      <div class="navbar-container">
        <div class="nav-actions">
          <button class="nav-btn menu-btn" onclick="toggleSidebar('left')"><i class="fas fa-bars"></i></button>
        </div>
        <div class="nav-center"></div>
        <div class="nav-actions">
          <a href="/profile#wishlist" class="nav-btn wishlist" aria-label="Wishlist" style="position:relative">
            <i class="fas fa-heart"></i>
            <span class="wishlist-badge" id="wishlistBadge">0</span>
          </a>
          <a href="/addtocart" class="nav-btn cart">
            <i class="fas fa-shopping-cart"></i>
            <span class="cart-badge">{{ (session.cart|default({})).values()|map(attribute='quantity')|sum if session and session.cart else 0 }}</span>
          </a>
        </div>
      </div>
    </nav>
  </div>

  <!-- Overlay -->
  <div class="overlay" id="overlay" onclick="closeAllSidebars()"></div>

  <!-- Sidebars -->
  <aside class="sidebar sidebar-left" id="leftSidebar">
    <div class="sidebar-header">
      <h2 class="sidebar-title">Categories</h2>
      <button class="close-btn" onclick="closeAllSidebars()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="sidebar-content">
      <div class="sidebar-scrollable">
        <ul class="category-list">
          <li class="category-item">
            <a href="/" class="category-link active">
              <i class="fas fa-home category-icon"></i>
              Home
            </a>
          </li>
          {% for category in categories %}
            <li class="category-item">
              <a href="/viewall?category={{ category.id }}" class="category-link">
                <i class="fas fa-tag category-icon"></i>
                {{ category.name }}
              </a>
            </li>
          {% endfor %}
          <li class="category-item">
            <a href="/viewall?category=uncategorized" class="category-link">
              <i class="fas fa-box-open category-icon"></i>
              Uncategorized
            </a>
          </li>
        </ul>
      </div>
      
    </div>
  </aside>

  <main class="container">
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="flash-container">
          {% for category, message in messages %}
            {% if category == 'error' %}
              <div class="flash flash-{{ category }}">{{ message }}</div>
            {% endif %}
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}
    
    <!-- Checkout Title Section with Total -->
    {% if cart_items %}
      {% set total = namespace(value=0) %}
      {% for item in cart_items %}
        {% set subtotal = item.price * item.quantity %}
        {% set total.value = total.value + subtotal %}
      {% endfor %}
    {% endif %}

    <!-- Order Summary - Left Section -->
    <aside class="card" style="grid-column: 1 / 2; margin-bottom: 2rem;">
      <h2>Order Summary</h2>
      {% if not cart_items %}
        <div class="empty">No items to show.</div>
      {% else %}
        <div class="order-items">
          {% set total = namespace(value=0) %}
          {% for item in cart_items %}
            {% set subtotal = item.price * item.quantity %}
            {% set total.value = total.value + subtotal %}
            <div class="order-item" style="cursor: pointer;" onclick="navigateToProduct(event, '{{ item.product_id }}')">
              <a href="/product/{{ item.product_id }}" class="order-thumb" style="display: block; text-decoration: none;"><img src="{{ item.image }}" alt="{{ item.name }}"></a>
              <div class="order-info">
                <a href="/product/{{ item.product_id }}" class="order-name" style="color: inherit; text-decoration: none; display: block; cursor: pointer;">{{ item.name }}</a>
                {% if item.img_var_name %}
                <div class="order-variations" style="font-size: 0.75rem; color: rgba(255,255,255,0.7); margin-top: 0.2rem; font-weight: 500;">
                  {{ item.img_var_name }}
                </div>
                {% endif %}
                {% if item.img_var_description %}
                <div class="order-variations" style="font-size: 0.65rem; color: rgba(255,255,255,0.5); margin-top: 0.1rem;">
                  {{ item.img_var_description }}
                </div>
                {% endif %}
                {% if item.variations and item.variations.strip() %}
                <div class="order-variations" style="font-size: 0.75rem; color: var(--text-light); margin-top: 0.2rem;">
                  {% set var_parts = item.variations.split(',') %}
                  {% for part in var_parts %}
                    {% if part.strip() %}
                      {% set key_val = part.split(':') %}
                      {% if key_val|length == 2 %}
                        <div>{{ key_val[0].strip().capitalize() }}: {{ key_val[1].strip() }}</div>
                      {% else %}
                        <div>{{ part.strip() }}</div>
                      {% endif %}
                    {% endif %}
                  {% endfor %}
                </div>
                {% endif %}
                <div class="order-meta">Qty: {{ item.quantity }}</div>
              </div>
              <div class="order-price">RWF {{ '{:,.0f}'.format(subtotal) }}</div>
            </div>
          {% endfor %}
        </div>
        
        <div class="total" style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid rgba(255,255,255,0.1);">
          <div style="font-weight: 700; font-size: 1rem; color: var(--text-primary); text-transform: uppercase; letter-spacing: 0.05em;">Total Amount</div>
          <div style="font-weight: 800; font-size: 1.4rem; color: rgba(255,255,255,0.85);">RWF {{ '{:,.0f}'.format(total.value) }}</div>
        </div>
      {% endif %}
    </aside>

    <!-- Address + MoMo Payment Form -->
    <section class="card" style="grid-column: 2 / 3;">
      {% if not cart_items %}
        <div class="empty">
          Your cart is empty. <a href="/" style="color: var(--accent); text-decoration: none; font-weight: 700;">Continue shopping</a>
        </div>
      {% else %}

        <form method="POST" action="/checkout" class="form">
          <input type="hidden" name="csrf_token" value="{{ session.csrf_token }}">
          <input type="hidden" id="latitude" name="latitude" value="{{ request.form.get('latitude','') }}">
          <input type="hidden" id="longitude" name="longitude" value="{{ request.form.get('longitude','') }}">
          
          <!-- Contact Information -->
          <div class="checkout-section">
            <div class="section-header">
              <h3>Contact</h3>
            </div>
            
            <div class="section-content">
              <div class="split">
                <div class="form-row">
                  <label for="full_name">Full Name</label>
                  <input id="full_name" name="full_name" type="text" placeholder="Your full name" value="{{ request.form.get('full_name', user_data.full_name if user_data and user_data.full_name else '') }}" required>
                </div>
                <div class="form-row">
                  <label for="delivery_phone">Phone Number</label>
                  <input id="delivery_phone" name="delivery_phone" type="tel" inputmode="numeric" placeholder="e.g., 0788123456" value="{{ request.form.get('delivery_phone', user_data.phone if user_data else '') }}" required>
                </div>
              </div>
              
              {% if not session.user_id %}
              <div class="form-row">
                <label for="guest_email">Email Address</label>
                <input id="guest_email" name="guest_email" type="email" placeholder="your.email@example.com" value="{{ request.form.get('guest_email', user_data.email if user_data else '') }}" required>
              </div>
              {% endif %}
            </div>
            
          </div>

          <!-- Address Information -->
          <div class="checkout-section">
            <div class="section-header">
              <h3>Address</h3>
            </div>
            
            <div class="section-content">
              <div class="split">
                <div class="form-row">
                  <label for="address_line">Street Address</label>
                  <input id="address_line" name="address_line" type="text" placeholder="Street, house number" value="{{ request.form.get('address_line', user_data.address if user_data and user_data.address else '') }}" required>
                </div>
                <div class="form-row">
                  <label for="city">City</label>
                  <input id="city" name="city" type="text" placeholder="City / District" value="{{ request.form.get('city', user_data.city if user_data and user_data.city else '') }}" required>
                </div>
              </div>
            </div>
            
          </div>

          <!-- Step 3: Delivery Location (Optional) -->
          <div class="checkout-section" data-section="3">
            <div class="section-header">
              <h3>Delivery Location <span style="color: var(--text-light); font-weight: 400; font-size: 0.8rem;">(Optional)</span></h3>
            </div>
            
            <div class="section-content">

              <!-- Location Selection -->
              <div class="form-row">
                <label>Pin Your Exact Delivery Location</label>
                
                <!-- Location Action Row -->
                <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1rem;">
                  <button type="button" id="locateBtn" style="background: rgba(229, 231, 235, 0.85); border: 2px solid rgba(229, 231, 235, 0.6); color: #000; padding: 0.5rem 1rem; font-size: 0.9rem; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; transition: none; font-weight: 600;">
                    <i class="fas fa-location-crosshairs"></i>Set My Location
                  </button>
                  <span style="color: var(--text-light); font-size: 0.8rem; font-weight: 500;">Secure & Private</span>
                </div>
                
                <!-- OpenStreetMap iframe container -->
                <div id="map"></div>
                
              </div>
            </div>
            
          </div>

          <!-- Step 4: Payment Information -->
          <div class="checkout-section">
            <div class="section-header">
              <h3>Payment</h3>
            </div>
            
            <div class="section-content">
              <!-- Delivery Notes -->
              <div class="form-row">
                <label for="delivery_notes">Delivery Notes (optional)</label>
                <input id="delivery_notes" name="notes" type="text" placeholder="Gate code, contact on arrival, etc." value="{{ request.form.get('notes','') }}">
              </div>
              
              <div class="form-row">
                <!-- Payment Method Tabs -->
                <div class="payment-tabs" role="tablist">
                  <button type="button" class="payment-tab-btn active" role="tab" aria-selected="true" data-method="cod">
                    <input type="radio" id="pay_cod" name="payment_method" value="cod" checked hidden>
                    <i class="fas fa-truck"></i>
                    <span>Cash on Delivery</span>
                  </button>
                  <button type="button" class="payment-tab-btn disabled" role="tab" aria-selected="false" data-method="momo" disabled>
                    <input type="radio" id="pay_momo" name="payment_method" value="momo" hidden disabled>
                    <i class="fas fa-mobile-alt"></i>
                    <span>Mobile Money</span>
                    <span class="coming-soon-badge">Coming Soon</span>
                  </button>
                </div>
              </div>
              
              <!-- MoMo Number -->
              <input type="hidden" id="provider" name="provider" value="MTN">
              <div class="form-row momo-number-field disabled-field hidden">
                <label for="momo_number">MoMo Number</label>
                <div class="input-container">
                  <input id="momo_number" name="momo_number" type="tel" inputmode="numeric" placeholder="e.g., 0788123456" value="{{ request.form.get('momo_number', '') }}" required disabled>
                  <div class="disabled-overlay">
                    <i class="fas fa-clock"></i>
                    <span>Coming Soon</span>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="payment-buttons">
              <button type="submit" id="btnCOD" class="pay-btn cod-btn">
                <i class="fas fa-check-circle"></i>
                Complete Order
              </button>
            </div>
          </div>
        </form>
      {% endif %}
    </section>
  </main>

  <!-- Payment Status Modal -->
  <div id="paymentModal" class="payment-modal">
    <div class="payment-modal-content">
      <div class="payment-icon pending" id="paymentIcon">
        <i class="fas fa-spinner spinner"></i>
      </div>
      <h3 class="payment-title" id="paymentTitle">Processing Payment...</h3>
      <p class="payment-message" id="paymentMessage">Please approve the payment on your phone.</p>
      <p class="payment-reference" id="paymentReference" style="display: none; font-size: 0.85rem; color: var(--text-secondary); margin-top: -1rem; margin-bottom: 1.5rem; font-family: monospace;"></p>
      <div class="payment-actions" id="paymentActions" style="display: none;">
        <button class="modal-btn modal-btn-primary" onclick="window.location.href='/'">Continue Shopping</button>
        <button class="modal-btn modal-btn-secondary" onclick="closePaymentModal()">Close</button>
      </div>
    </div>
  </div>

  <!-- COD Success Modal -->
  <div id="codSuccessModal" class="cod-success-modal">
    <div class="cod-success-content">
      <div class="cod-success-icon">
        <i class="fas fa-check-circle"></i>
      </div>
      <h3 class="cod-success-title">Order Placed Successfully!</h3>
      <p class="cod-success-message" id="codSuccessMessage">
        Your order has been placed successfully. You will pay cash on delivery when your order arrives.
      </p>
      <div class="cod-order-info">
        <div class="cod-order-number">Order Number</div>
        <div class="cod-order-id" id="codOrderId">#12345</div>
      </div>
      <div class="cod-success-actions">
        <button class="cod-btn-primary" onclick="window.location.href='/'">
          <i class="fas fa-shopping-cart"></i> Continue Shopping
        </button>
        <button class="cod-btn-secondary" onclick="closeCODModal()">
          Close
        </button>
      </div>
    </div>
  </div>

  <script>
    let paymentRef = null;
    let verificationInterval = null;
    let currentStep = 1;

    // Step Navigation Functions
    function nextStep() {
      if (currentStep < 4) {  // Allow navigation to step 4
        // Validate current step before proceeding
        if (validateCurrentStep()) {
          currentStep++;
          updateStepDisplay();
        }
      }
    }

    function prevStep() {
      if (currentStep > 1) {
        currentStep--;
        updateStepDisplay();
      }
    }

    function validateCurrentStep() {
      const currentSection = document.querySelector(`.checkout-section[data-section="${currentStep}"]`);
      const requiredInputs = currentSection.querySelectorAll('input[required]');
      
      for (let input of requiredInputs) {
        if (!input.value.trim()) {
          input.focus();
          input.reportValidity();
          return false;
        }
      }
      return true;
    }

    function updateStepDisplay() {
      // Update step indicators
      document.querySelectorAll('.step').forEach((step, index) => {
        const stepNum = index + 1;
        step.classList.remove('active', 'completed');
        
        if (stepNum === currentStep) {
          step.classList.add('active');
        } else if (stepNum < currentStep) {
          step.classList.add('completed');
          // Change number to checkmark for completed steps
          const stepNumber = step.querySelector('.step-number');
          stepNumber.innerHTML = stepNum < currentStep ? '<i class="fas fa-check"></i>' : stepNum;
        } else {
          // Reset to number for future steps
          const stepNumber = step.querySelector('.step-number');
          stepNumber.innerHTML = stepNum;
        }
      });

      // Update section visibility
      document.querySelectorAll('.checkout-section').forEach(section => {
        section.classList.remove('active');
      });
      
      const activeSection = document.querySelector(`.checkout-section[data-section="${currentStep}"]`);
      if (activeSection) {
        activeSection.classList.add('active');
      }

      // Update payment method visibility
      updatePaymentMethodVisibility();
    }

    function updatePaymentMethodVisibility() {
      const momoField = document.querySelector('.momo-number-field');
      const codBtn = document.getElementById('btnCOD');
      const momoBtn = document.getElementById('btnMomo');
      const selectedMethod = document.querySelector('input[name="payment_method"]:checked')?.value;

      if (selectedMethod === 'cod') {
        if (momoField) momoField.style.display = 'none';
        if (codBtn) codBtn.classList.remove('hidden');
        if (momoBtn) momoBtn.classList.add('hidden');
      } else {
        if (momoField) momoField.style.display = 'block';
        if (codBtn) codBtn.classList.add('hidden');
        if (momoBtn) momoBtn.classList.remove('hidden');
      }
    }

    // Payment Tab Switching Function
    function switchPaymentTab(method) {
      const targetTab = document.querySelector(`[data-method="${method}"]`);
      
      // Check if the payment method is disabled
      if (targetTab && targetTab.classList.contains('disabled')) {
        // Show a friendly message for disabled payment methods
        if (method === 'momo') {
          // Create a temporary notification
          const notification = document.createElement('div');
          notification.style.cssText = `
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(21, 25, 34, 0.95);
            color: rgba(255, 255, 255, 0.9);
            padding: 1rem 1.5rem;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 10000;
            font-size: 0.9rem;
            text-align: center;
            backdrop-filter: blur(8px);
          `;
          notification.innerHTML = `
            <i class="fas fa-clock" style="margin-right: 0.5rem; color: #f59e0b;"></i>
            Mobile Money payment is coming soon!
          `;
          
          document.body.appendChild(notification);
          
          // Remove notification after 2 seconds
          setTimeout(() => {
            if (notification.parentNode) {
              notification.remove();
            }
          }, 2000);
        }
        return; // Don't switch to disabled payment method
      }
      
      // Remove active class from all tabs
      document.querySelectorAll('.payment-tab-btn').forEach(tab => {
        tab.classList.remove('active');
        tab.setAttribute('aria-selected', 'false');
      });
      
      // Add active class to clicked tab
      if (targetTab) {
        targetTab.classList.add('active');
        targetTab.setAttribute('aria-selected', 'true');
      }
      
      // Check the corresponding radio button
      const radio = document.querySelector(`input[value="${method}"]`);
      if (radio && !radio.disabled) {
        radio.checked = true;
        updatePaymentMethodVisibility();
      }
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
      updateStepDisplay();
      
      // Add event listeners for payment method changes
      document.querySelectorAll('input[name="payment_method"]').forEach(radio => {
        radio.addEventListener('change', updatePaymentMethodVisibility);
      });
      
      // Add event listeners for payment tab buttons
      document.querySelectorAll('.payment-tab-btn').forEach(tab => {
        tab.addEventListener('click', function() {
          // Ignore disabled payment methods (e.g., Coming Soon)
          if (this.classList.contains('disabled')) return;
          
          const method = this.getAttribute('data-method');
          switchPaymentTab(method);
        });
      });
    });

    function initiatePayment(method) {
      console.log('Payment method:', method);
      
      const form = document.querySelector('.form');
      if (!form) {
        console.error('Form not found');
        return;
      }

      if (!form.checkValidity()) {
        form.reportValidity();
        return;
      }

      // If method parameter is not provided, get it from radio buttons
      method = method || (document.querySelector('input[name="payment_method"]:checked')?.value) || 'momo';
      console.log('Using payment method:', method);
      const formData = new FormData(form);
      const isCOD = method === 'cod';
      const url = isCOD ? '/pay/cod' : '/pay/simple';
      console.log('Submitting to:', url);
      
      showPaymentModal('pending', isCOD ? 'Placing Order...' : 'Processing Payment...', isCOD ? 'Creating your Cash on Delivery order.' : 'Please approve the payment on your phone.');

      fetch(url, {
        method: 'POST',
        body: formData
      })
      .then(response => {
        console.log('Response status:', response.status);
        return response.json();
      })
      .then(data => {
        console.log('Payment response:', data);
        
        if (data.status === 'successful') {
          showPaymentModal('success', 
            isCOD ? 'Order Confirmed!' : 'Payment Successful!', 
            data.message || (isCOD ? 'Order placed successfully! You will pay cash on delivery.' : 'Thank you for your purchase!'),
            data.details
          );
          setTimeout(() => { window.location.href = '/'; }, 3000);
        } else if (data.status === 'failed') {
          showPaymentModal('failed', 'Payment Failed', data.message || 'Payment could not be processed.', data.details);
        } else if (data.status === 'pending') {
          showPaymentModal('pending', 'Awaiting Approval...', data.message || 'Please approve the payment on your phone.', data.details);
        } else {
          showPaymentModal('failed', 'Payment Error', data.message || 'An unexpected error occurred.');
        }
      })
      .catch(error => {
        console.error('Payment error:', error);
        showPaymentModal('failed', 'Network Error', 'Unable to connect to payment service. Please check your internet connection and try again.');
      });
    }

    // verifyPayment removed during reset

    function showPaymentModal(status, title, message, details = null, guestEmail = null) {
      const modal = document.getElementById('paymentModal');
      const icon = document.getElementById('paymentIcon');
      const titleEl = document.getElementById('paymentTitle');
      const messageEl = document.getElementById('paymentMessage');
      const refEl = document.getElementById('paymentReference');
      const actions = document.getElementById('paymentActions');

      icon.className = 'payment-icon ' + status;
      
      // Simple display without transaction details
      let refText = '';
      
      if (status === 'pending') {
        icon.innerHTML = '<i class="fas fa-spinner spinner"></i>';
        actions.style.display = 'none';
        refEl.style.display = 'none';
      } else if (status === 'success') {
        icon.innerHTML = '<i class="fas fa-check-circle"></i>';
        actions.style.display = 'flex';
        refEl.style.display = 'none';
        
        // Update buttons for guest registration if applicable
        if (guestEmail) {
          actions.innerHTML = `
            <button class="modal-btn modal-btn-primary" onclick="window.location.href='/login'">
              <i class="fas fa-user-plus"></i> Create Account
            </button>
            <button class="modal-btn modal-btn-secondary" onclick="window.location.href='/'">
              <i class="fas fa-shopping-cart"></i> Continue Shopping
            </button>
          `;
        }
      } else if (status === 'failed') {
        icon.innerHTML = '<i class="fas fa-times-circle"></i>';
        actions.style.display = 'flex';
        refEl.style.display = 'none';
      }

      titleEl.textContent = title;
      messageEl.textContent = message;
      modal.style.display = 'block';
    }

    function closePaymentModal() {
      document.getElementById('paymentModal').style.display = 'none';
      if (verificationInterval) {
        clearInterval(verificationInterval);
      }
    }

    function showCODSuccessModal(message, orderId) {
      // Close any existing payment modal first
      closePaymentModal();
      
      const modal = document.getElementById('codSuccessModal');
      const messageEl = document.getElementById('codSuccessMessage');
      const orderIdEl = document.getElementById('codOrderId');
      
      if (messageEl) {
        messageEl.textContent = message;
      }
      
      if (orderIdEl && orderId) {
        orderIdEl.textContent = '#' + orderId;
      }
      
      modal.style.display = 'block';
      
      // Auto-redirect after 8 seconds
      setTimeout(() => {
        window.location.href = '/';
      }, 8000);
    }

    function closeCODModal() {
      document.getElementById('codSuccessModal').style.display = 'none';
    }

    function toggleSidebar(side) {
      const sidebar = document.getElementById(side + 'Sidebar');
      const overlay = document.getElementById('overlay');
      closeAllSidebars();
      sidebar.classList.toggle('active');
      if (sidebar.classList.contains('active')) {
        overlay.classList.add('active');
      }
    }

    function closeAllSidebars() {
      document.getElementById('leftSidebar')?.classList.remove('active');
      document.getElementById('overlay')?.classList.remove('active');
    }

    // ============================================
    // Pure OpenStreetMap - NO LEAFLET, NO DUPLICATES
    // ============================================
    document.addEventListener('DOMContentLoaded', function () {
      const mapContainer = document.getElementById('map');
      if (!mapContainer) return;

      const latInput = document.getElementById('latitude');
      const lngInput = document.getElementById('longitude');
      
      // Default: Kigali, Rwanda
      let lat = -1.9441, lng = 30.0619;
      
      // Load saved coords if available
      if (latInput?.value && lngInput?.value) {
        const l1 = parseFloat(latInput.value);
        const l2 = parseFloat(lngInput.value);
        if (!isNaN(l1) && !isNaN(l2)) {
          lat = l1; lng = l2;
        }
      }
      
      // Update map function
      function updateMap() {
        const zoom = 15;
        const bbox = `${lng - 0.005},${lat - 0.005},${lng + 0.005},${lat + 0.005}`;
        const embedUrl = `https://www.openstreetmap.org/export/embed.html?bbox=${bbox}&layer=mapnik&marker=${lat},${lng}`;
        
        mapContainer.innerHTML = `
          <iframe 
            src="${embedUrl}"
            width="100%" 
            height="100%" 
            frameborder="0" 
            scrolling="no"
            marginheight="0"
            marginwidth="0"
            sandbox="allow-scripts allow-same-origin allow-popups"
            style="border:none; border-radius:12px; display:block;"
            loading="lazy"
          ></iframe>
        `;
        
        // Update hidden inputs
        if (latInput) latInput.value = lat.toFixed(7);
        if (lngInput) lngInput.value = lng.toFixed(7);
      }
      
      // Initial map render
      updateMap();
      
      // Use My Location button
      const locateBtn = document.getElementById('locateBtn');
      if (locateBtn) {
        locateBtn.addEventListener('click', () => {
          if (!navigator.geolocation) {
            alert('Geolocation not supported');
            return;
          }
          
          locateBtn.disabled = true;
          locateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Locating...';
          
          navigator.geolocation.getCurrentPosition(
            (pos) => {
              lat = pos.coords.latitude;
              lng = pos.coords.longitude;
              updateMap();
              locateBtn.innerHTML = '<i class="fas fa-check"></i> Location Set';
              setTimeout(() => {
                locateBtn.innerHTML = '<i class="fas fa-location-crosshairs"></i> Use My Location';
                locateBtn.disabled = false;
              }, 2000);
            },
            (err) => {
              alert('Could not get location. Please enter address manually.');
              locateBtn.innerHTML = '<i class="fas fa-location-crosshairs"></i> Use My Location';
              locateBtn.disabled = false;
            }
          );
        });
      }
      
      console.log('OpenStreetMap: LOADED (No Leaflet, No Duplicates)');
    });

  (function wirePaymentToggle(){
      const momoInput = document.getElementById('momo_number');
      const radioMomo = document.getElementById('pay_momo');
      const radioCOD = document.getElementById('pay_cod');
      const btnMomo = document.getElementById('btnMomo');
      const btnCOD = document.getElementById('btnCOD');
      const paymentOptions = document.querySelectorAll('.payment-option');
      
      function setMode(mode){
        console.log('Setting payment mode to:', mode);
        const isCOD = mode === 'cod';
        
        // Update option active states
        paymentOptions.forEach(option => {
          const optionMethod = option.getAttribute('data-method');
          if (optionMethod === mode) {
            option.classList.add('active');
          } else {
            option.classList.remove('active');
          }
        });
        
        // Update radio buttons
        if (radioMomo) radioMomo.checked = (mode === 'momo');
        if (radioCOD) radioCOD.checked = (mode === 'cod');
        
        if (momoInput) {
          momoInput.required = !isCOD;
          const momoField = document.querySelector('.momo-number-field');
          if (momoField) {
            if (isCOD) {
              momoField.classList.add('hidden');
            } else {
              momoField.classList.remove('hidden');
            }
          }
        }
        
        if (btnMomo) {
          if (isCOD) {
            btnMomo.classList.add('hidden');
          } else {
            btnMomo.classList.remove('hidden');
          }
        }
        
        if (btnCOD) {
          if (isCOD) {
            btnCOD.classList.remove('hidden');
          } else {
            btnCOD.classList.add('hidden');
          }
        }
      }
      
      // Add click listeners to payment options
      paymentOptions.forEach(option => {
        option.addEventListener('click', () => {
          const method = option.getAttribute('data-method');
          setMode(method);
        });
      });
      
      if (radioMomo) radioMomo.addEventListener('change', ()=> setMode('momo'));
      if (radioCOD) radioCOD.addEventListener('change', ()=> setMode('cod'));
      
      // Set initial mode (default to COD since MoMo is disabled)
      const checkedRadio = document.querySelector('input[name="payment_method"]:checked');
      const initialMode = checkedRadio ? checkedRadio.value : 'cod';
      setMode(initialMode);
    })();
  </script>

  <!-- Wishlist Count Script -->
  <script>
    // Fetch and update wishlist count
    async function updateWishlistCount() {
      try {
        const response = await fetch('/api/wishlist/count');
        const data = await response.json();
        const badge = document.getElementById('wishlistBadge');
        if (badge) {
          const count = (data && typeof data.count !== 'undefined') ? data.count : 0;
          badge.textContent = count;
          badge.style.display = 'flex';
        }
      } catch (error) {
        const badge = document.getElementById('wishlistBadge');
        if (badge) { badge.textContent = '0'; badge.style.display = 'flex'; }
        console.error('Error fetching wishlist count:', error);
      }
    }

    // Navigate to product function for clickable order items
    function navigateToProduct(event, productId) {
      // Don't navigate if clicking on buttons
      if (event.target.closest('button') || event.target.closest('a')) {
        return;
      }
      window.location.href = `/product/${productId}`;
    }

    // Update count on page load
    document.addEventListener('DOMContentLoaded', updateWishlistCount);
  </script>

  <!-- Success Modal -->
  {% if show_success_modal %}
  <div id="successModal" class="success-modal-overlay">
    <div class="success-modal">
      <div class="success-icon">
        <svg width="64" height="64" viewBox="0 0 24 24" fill="none">
          <circle cx="12" cy="12" r="10" stroke="#10B981" stroke-width="2" fill="#F0FDF4"/>
          <path d="m9 12 2 2 4-4" stroke="#10B981" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </div>
      <h2 class="success-title">Order Placed Successfully!</h2>
      <p class="success-message">Your order #{{ order_id }} has been confirmed.<br>You will pay cash on delivery.</p>
      <div class="success-actions">
        <button onclick="goToProfile()" class="success-btn primary">View Order</button>
        <button onclick="continueShopping()" class="success-btn secondary">Continue Shopping</button>
      </div>
    </div>
  </div>

  <style>
    .success-modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      backdrop-filter: blur(4px);
    }

    .success-modal {
      background: #11151d;
      border-radius: 16px;
      padding: 32px;
      max-width: 400px;
      width: 90%;
      text-align: center;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5), 0 10px 10px -5px rgba(0, 0, 0, 0.4);
      border: 1px solid #202431;
      animation: slideUp 0.3s ease-out;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .success-icon {
      margin-bottom: 16px;
    }

    .success-title {
      font-size: 24px;
      font-weight: 600;
      color: #e8eaee;
      margin: 0 0 8px 0;
    }

    .success-message {
      font-size: 16px;
      color: #9aa3b2;
      margin: 0 0 24px 0;
      line-height: 1.5;
    }

    .success-actions {
      display: flex;
      gap: 12px;
      justify-content: center;
    }

    .success-btn {
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
    }

    .success-btn.primary {
      background: rgba(255,255,255,0.85);
      color: #111318;
      border: 1px solid rgba(255,255,255,0.35);
      box-shadow: 0 8px 18px rgba(0,0,0,0.22);
    }

    .success-btn.primary:hover {
      background: rgba(255,255,255,0.9);
    }

    .success-btn.secondary {
      background: #0e1117;
      color: #e8eaee;
      border: 1px solid #202431;
    }

    .success-btn.secondary:hover {
      background: #111827;
    }

    @media (max-width: 480px) {
      .success-modal {
        padding: 24px;
        margin: 16px;
      }
      
      .success-actions {
        flex-direction: column;
      }
      
      .success-btn {
        width: 100%;
      }
    }
  </style>

  <script>
    function goToProfile() {
      window.location.href = '/profile#orders';
    }

    function continueShopping() {
      window.location.href = '/';
    }

  </script>
  {% endif %}

  <!-- Global Loading JavaScript -->
  <script src="{{ url_for('static', filename='js/global-loading.js') }}"></script>
</body>
</html>
