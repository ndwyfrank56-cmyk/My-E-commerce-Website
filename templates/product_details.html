<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{ product.name }} - CiTiPlug</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Playfair+Display:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/loading.css', v='29') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/global-loading.css') }}">
  <style>
    :root {
      --bg: #0f1115;
      --panel: #151922;
      --panel-2: #1b202b;
      --border: #2a2f3a;
      --text-primary: #e5e7eb;
      --text-secondary: #a1a8b3;
      --text-light: #7b8494;
      --price-tag-green: #2e4d2c;
      --accent: #111318;
      --accent-hover: #1d2228;
      --border-radius: 12px;
      --transition: all .25s ease;
    }
    /* Image variation thumbnails: no borders by default; only selected shows border */
    .image-variations-container .image-variation-item div,
    .image-variations-container .image-variation-item > div,
    .image-variations-strip .image-variation-item div,
    .image-variations-strip .image-variation-item > div{
      border: none !important;
      border-color: transparent !important;
      box-shadow: none !important;
      outline: none !important;
      -webkit-box-shadow: none !important;
    }
    .image-variations-container .image-variation-item:hover div,
    .image-variations-container .image-variation-item:focus div,
    .image-variations-container .image-variation-item:active div,
    .image-variations-strip .image-variation-item:hover div,
    .image-variations-strip .image-variation-item:focus div{
      border: none !important;
      border-color: transparent !important;
      box-shadow: none !important;
      outline: none !important;
      -webkit-box-shadow: none !important;
    }
    /* Kill any global focus styles */
    .image-variation-item *:focus,
    .image-variation-item *:focus-visible{
      outline: none !important;
      box-shadow: none !important;
      border-color: transparent !important;
    }
    * { 
      margin:0; 
      padding:0; 
      box-sizing:border-box; 
      -webkit-tap-highlight-color: transparent;
      -webkit-touch-callout: none;
    }
    body { 
      font-family: 'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, sans-serif; 
      background: var(--bg); 
      color: var(--text-primary);
    }
    
    /* Remove number input spinners */
    input[type="number"]::-webkit-inner-spin-button,
    input[type="number"]::-webkit-outer-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    input[type="number"] {
      -moz-appearance: textfield;
      appearance: textfield;
    }
    .navbar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1000;
      background: var(--panel);
      border-bottom: none;
      transition: var(--transition);
    }
    .navbar-container { max-width: 1400px; margin: 0 auto; padding: 1rem 2rem; display: flex; align-items: center; justify-content: space-between; }
    .navbar-top,
    .navbar-bottom { border-bottom: none; }
    .navbar-top .navbar-container { padding: 0.75rem 2rem; }
    .navbar-bottom .navbar-container { padding: 0.6rem 2rem; display: grid; grid-template-columns: auto 1fr auto; align-items: center; gap: 1rem; }
    .logo { font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; font-weight: 800; letter-spacing: 0.02em; color: rgba(255,255,255,0.92) !important; text-decoration: none; font-size: 1.8rem; }
    .logo:visited,
    .logo:hover { color: rgba(255,255,255,0.92) !important; text-decoration: none; }
    .logo .logo-cart{ position:relative; top:1px; color: var(--price-tag-green); }
    .nav-actions { display: flex; align-items: center; gap: 0.75rem; }
    .nav-btn { position: relative; padding: 0.55rem; border: 1px solid rgba(255,255,255,0.12); background: var(--panel-2); border-radius: var(--border-radius); cursor: pointer; color: var(--text-secondary); font-size: 1.1rem; transition: var(--transition); text-decoration: none; box-shadow: none; }
    .wishlist-badge { position: absolute; top: -6px; right: -6px; background: #d1d5db; color: #111318; border: 1px solid #9ca3af; border-radius: 50%; width: 22px; height: 22px; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: 700; box-shadow: 0 0 0 1px rgba(0,0,0,0.35), 0 6px 14px rgba(0,0,0,0.25); }
    .nav-btn.profile { width: 40px; height: 40px; padding: 0; display: flex; align-items: center; justify-content: center; border-radius: 50%; border: 1px solid rgba(255,255,255,0.35); background: rgba(255,255,255,0.85); box-shadow: inset 0 1px 0 rgba(255,255,255,0.55), inset 0 -1px 0 rgba(0,0,0,0.08), 0 6px 14px rgba(0,0,0,0.20); }
    .nav-btn.profile i { color: #111318; }
    .nav-btn.profile:hover { background: rgba(255,255,255,0.92); border-color: rgba(255,255,255,0.45); box-shadow: 0 10px 22px rgba(0,0,0,0.22); }

    /* Search Bar Styles */
    .nav-center {
      display: flex;
      align-items: center;
      flex: 1;
      justify-content: center;
      width: 100%;
    }

    #wrap {
      margin: 0;
      display: inline-block;
      position: relative;
      height: 50px;
      padding: 0;
    }

    #wrap input[type="text"] {
      height: 50px;
      font-size: 14px;
      display: inline-block;
      font-family: "Lato", sans-serif;
      font-weight: 100;
      border: none;
      outline: none;
      color: #333;
      padding: 3px;
      padding-right: 50px;
      width: 0px;
      position: absolute;
      top: 0;
      right: 0;
      background: white;
      z-index: 3;
      transition: width .4s cubic-bezier(0.000, 0.795, 0.000, 1.000);
      cursor: pointer;
      border-radius: 25px;
    }

    #wrap input[type="text"]:focus:hover {
      border-bottom: 1px solid #BBB;
    }

    #wrap input[type="text"]:focus {
      width: 250px;
      z-index: 1;
      border-bottom: 1px solid #BBB;
      cursor: text;
    }

    #wrap input[type="submit"] {
      height: 50px;
      width: 50px;
      display: inline-block;
      color: red;
      float: right;
      background: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAMAAABg3Am1AAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAADNQTFRFU1NT9fX1lJSUXl5e1dXVfn5+c3Nz6urqv7+/tLS0iYmJqampn5+fysrK39/faWlp////Vi4ZywAAABF0Uk5T/////////////////////wAlrZliAAABLklEQVR42rSWWRbDIAhFHeOUtN3/ags1zaA4cHrKZ8JFRHwoXkwTvwGP1Qo0bYObAPwiLmbNAHBWFBZlD9j0JxflDViIObNHG/Do8PRHTJk0TezAhv7qloK0JJEBh+F8+U/hopIELOWfiZUCDOZD1RADOQKA75oq4cvVkcT+OdHnqqpQCITWAjnWVgGQUWz12lJuGwGoaWgBKzRVBcCypgUkOAoWgBX/L0CmxN40u6xwcIJ1cOzWYDffp3axsQOyvdkXiH9FKRFwPRHYZUaXMgPLeiW7QhbDRciyLXJaKheCuLbiVoqx1DVRyH26yb0hsuoOFEPsoz+BVE0MRlZNjGZcRQyHYkmMp2hBTIzdkzCTc/pLqOnBrk7/yZdAOq/q5NPBH1f7x7fGP4C3AAMAQrhzX9zhcGsAAAAASUVORK5CYII=) center center no-repeat;
      text-indent: -10000px;
      border: none;
      position: absolute;
      top: 0;
      right: 0;
      z-index: 2;
      cursor: pointer;
      opacity: 0.4;
      transition: opacity .4s ease;
      border-radius: 50%;
    }

    #wrap input[type="submit"]:hover {
      opacity: 0.8;
    }

    .search-dropdown {
      position: fixed;
      top: auto;
      left: 50%;
      transform: translateX(-50%);
      background: var(--panel-2);
      border-radius: 10px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
      max-height: 400px;
      overflow-y: auto;
      z-index: 9999;
      display: none;
      border: 1px solid var(--border);
      width: 90vw;
      max-width: 1000px;
    }

    .search-result-item {
      padding: 12px;
      border-bottom: 1px solid #EEE;
      cursor: pointer;
      transition: background 0.2s;
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .search-result-item:hover {
      background: rgba(255, 255, 255, 0.08);
    }

    .search-result-item img {
      width: 40px;
      height: 40px;
      object-fit: cover;
      border-radius: 4px;
    }

    .search-result-info {
      flex: 1;
    }

    .search-result-name {
      font-weight: 600;
      color: #333;
      font-size: 14px;
    }

    .search-result-price {
      color: #666;
      font-size: 12px;
    }

    .nav-btn.wishlist { border: none; background: transparent; padding: 0.55rem; color: var(--text-secondary); font-size: 1.2rem; position: relative; text-decoration: none; }
    .nav-btn.wishlist i { color: #d1d5db; }
    .nav-btn.wishlist:hover i { color: #f3f4f6; }

    .nav-btn.cart {
      border: none;
      background: transparent;
      padding: 0.55rem;
      position: relative;
    }

    .cart-badge {
      position: absolute;
      top: -6px;
      right: -6px;
      background: rgba(255, 255, 255, 0.2);
      color: #fff;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      font-weight: 700;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }

    .user-info { display: flex; flex-direction: column; align-items: center; gap: 0.25rem; }
    .user-welcome { color: var(--text-secondary); font-size: 0.75rem; font-weight: 500; text-align: center; max-width: 80px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    /* Burger button (match Home) */
    .menu-btn { display: inline-flex; align-items: center; justify-content: center; padding: 0.55rem; border: none; background: transparent; color: var(--text-secondary); font-size: 1.1rem; cursor: pointer; transition: none; }
    .menu-btn i { color: var(--text-secondary); }
    /* Sidebar + overlay (match Home) */
    .overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px); opacity: 0; visibility: hidden; transition: var(--transition); z-index: 1050; }
    .overlay.active { opacity: 1; visibility: visible; }

    /* Mini Cart Overlay */
    .mini-cart-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.75); backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px); opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; z-index: 9998; }
    .mini-cart-overlay.active { opacity: 1; visibility: visible; }

    /* Mini Cart Sidebar */
    .mini-cart { position: fixed; top: 0; right: 0; width: 420px; max-width: 90vw; height: 100vh; background: linear-gradient(180deg, #0f1318 0%, #0a0d12 100%); box-shadow: -8px 0 32px rgba(0, 0, 0, 0.6); transform: translateX(100%); transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1); z-index: 9999; display: flex; flex-direction: column; border-left: 1px solid rgba(255, 255, 255, 0.1); overflow: hidden; }
    .mini-cart.active { transform: translateX(0); }
    .mini-cart-header { flex-shrink: 0; display: flex; align-items: center; justify-content: space-between; padding: 1.25rem 1.25rem; border-bottom: 1px solid rgba(255, 255, 255, 0.08); background: rgba(0, 0, 0, 0.3); }
    .mini-cart-title { display: flex; align-items: center; gap: 0.75rem; font-size: 1.1rem; font-weight: 700; color: #fff; text-transform: uppercase; letter-spacing: 0.5px; }
    .mini-cart-title i { font-size: 1.3rem; color: rgba(255, 255, 255, 0.7); }
    .cart-header-buttons {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }

    .btn-view-cart-header {
      padding: 0.6rem 1.2rem;
      background: rgba(229, 231, 235, 0.9);
      color: #111318;
      border: 1px solid rgba(255, 255, 255, 0.15);
      border-radius: 8px;
      text-decoration: none;
      font-size: 0.8rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      width: 90px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      text-transform: lowercase;
      gap: 0.3rem;
    }
    .btn-view-cart-header i {
      font-size: 0.7rem;
      color: #333;
    }

    .btn-view-cart-header:hover {
      background: rgba(229, 231, 235, 0.9);
      color: #111318;
      transform: none;
    }

    /* Share buttons - minimal dark icons */
    .share-container {
      display: flex;
      gap: 0.5rem;
      padding: 0.25rem 0 0;
      flex-wrap: wrap;
      align-items: center;
    }
    .share-link {
      background: transparent;
      border: none;
      border-radius: 4px;
      color: rgba(229,231,235,0.7);
      width: 32px;
      height: 32px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      padding: 0;
      transition: none;
    }
    .share-link i {
      font-size: 1rem;
    }

    .btn-checkout-header {
      padding: 0.6rem 1.2rem;
      background: rgba(229, 231, 235, 0.9);
      color: #111318;
      border: 1px solid rgba(255, 255, 255, 0.15);
      border-radius: 8px;
      font-size: 0.8rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      width: 90px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      text-transform: none;
      gap: 0.3rem;
    }
    .btn-checkout-header i {
      font-size: 0.7rem;
      color: #333;
    }

    .btn-checkout-header:hover {
      background: rgba(229, 231, 235, 1);
      color: #000;
      transform: translateY(-1px);
    }

    .qty-simple {
      display: inline-block;
      color: rgba(255, 255, 255, 0.8);
      font-size: 12px;
      font-weight: 600;
      min-width: 20px;
      text-align: center;
    }

    .mini-cart-count { color: rgba(255, 255, 255, 0.6); font-weight: 700; font-size: 0.95rem; }
    .mini-cart-close { width: 48px; height: 48px; display: flex; align-items: center; justify-content: center; background: transparent; border: none; border-radius: 8px; color: #fff; font-size: 1.3rem; cursor: pointer; }
    .mini-cart-body { flex: 1; overflow-y: auto; overflow-x: hidden; min-height: 0; scrollbar-width: none; -ms-overflow-style: none; }
    .mini-cart-body::-webkit-scrollbar { display: none; width: 0; height: 0; }
    .mini-cart-items { padding: 0; overflow-y: auto; scrollbar-width: none; -ms-overflow-style: none; }
    .mini-cart-items::-webkit-scrollbar { display: none; width: 0; height: 0; }
    .mini-cart-empty { display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 4rem 2rem; min-height: 400px; }
    .empty-icon { width: 100px; height: 100px; display: flex; align-items: center; justify-content: center; background: rgba(255, 255, 255, 0.05); border-radius: 50%; margin-bottom: 1.5rem; }
    .empty-icon i { font-size: 3rem; color: rgba(255, 255, 255, 0.4); }
    .mini-cart-empty h3 { font-size: 1.4rem; font-weight: 700; color: #fff; margin-bottom: 0.5rem; }
    .mini-cart-empty p { font-size: 0.95rem; color: #8b92a3; margin-bottom: 2rem; }
    .btn-continue-shopping { display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.875rem 1.75rem; background: rgba(255, 255, 255, 0.15); color: #fff; font-weight: 600; font-size: 0.95rem; border: none; border-radius: 10px; cursor: pointer; }
    .mini-cart-item { display: flex; gap: 1rem; padding: 1.25rem 1.25rem; border-bottom: 1px solid rgba(255, 255, 255, 0.03); position: relative; }
    .item-image { width: 80px; height: 80px; flex-shrink: 0; border-radius: 10px; overflow: hidden; background: rgba(255, 255, 255, 0.05); }
    .item-image img { width: 100%; height: 100%; object-fit: cover; }
    .item-details { flex: 1; min-width: 0; }
    .item-name { font-size: 0.95rem; font-weight: 600; color: #fff; margin: 0 0 0.5rem 0; line-height: 1.3; display: -webkit-box; -webkit-line-clamp: 2; line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
    .item-variant { font-size: 0.8rem; color: #8b92a3; margin: 0 0 0.75rem 0; }
    .item-price-qty { display: flex; align-items: center; justify-content: space-between; gap: 1rem; }
    .item-price { font-size: 1rem; font-weight: 700; color: rgba(255, 255, 255, 0.9); }
    .item-quantity { display: inline-flex; align-items: center; gap: 0.5rem; background: rgba(255, 255, 255, 0.05); border-radius: 8px; padding: 0.25rem 0.5rem; }
    .qty-btn { width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; background: rgba(255, 255, 255, 0.08); border: none; border-radius: 6px; color: #fff; font-size: 0.75rem; cursor: pointer; transition: all 0.2s ease; }
    .qty-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .qty-value { min-width: 24px; text-align: center; font-weight: 600; color: #fff; font-size: 0.9rem; }
    .item-remove { position: absolute; top: 1rem; right: 1rem; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; background: transparent; border: none; border-radius: 6px; color: #ef4444; font-size: 1rem; cursor: pointer; }
    .mini-cart-footer { flex-shrink: 0; padding: 1rem 1.25rem; border-top: none; background: linear-gradient(180deg, rgba(15, 19, 24, 0.95) 0%, rgba(10, 13, 18, 0.98) 100%); box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.4); }
    .cart-subtotal { display: flex; align-items: center; justify-content: space-between; padding: 0.875rem 0; margin-bottom: 0.875rem; }
    .subtotal-label { font-size: 0.75rem; font-weight: 600; color: rgba(255, 255, 255, 0.5); text-transform: uppercase; letter-spacing: 0.5px; }
    .subtotal-amount { font-size: 1.2rem; font-weight: 700; color: rgba(255, 255, 255, 0.95); }
    .cart-buttons { display: flex; gap: 0.625rem; }
    .btn-checkout { flex: 1; display: flex; align-items: center; justify-content: center; gap: 0.5rem; padding: 0.8rem 1.2rem; background: rgba(255, 255, 255, 0.98); color: #0a0d12; font-weight: 600; font-size: 0.9rem; border: none; border-radius: 8px; cursor: pointer; text-transform: none; letter-spacing: 0.3px; transition: all 0.2s ease; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); }
    .btn-checkout:hover { background: rgba(255, 255, 255, 1); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); }
    .btn-view-cart { flex: 1; display: flex; align-items: center; justify-content: center; padding: 0.8rem 1.2rem; color: rgba(255, 255, 255, 0.85); font-size: 0.9rem; font-weight: 600; text-decoration: none; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.15); border-radius: 8px; transition: all 0.2s ease; }
    .btn-view-cart:hover { background: rgba(255, 255, 255, 0.15); border-color: rgba(255, 255, 255, 0.25); color: rgba(255, 255, 255, 0.95); }
    @media (max-width: 768px) {
      .mini-cart { width: 100%; max-width: 100%; }
      .mini-cart-header { padding: 1.25rem 1rem; }
      .mini-cart-item { padding: 1rem; }
      .item-image { width: 70px; height: 70px; }
      .mini-cart-footer { 
        padding: 1.25rem 1rem 1.5rem; 
        position: sticky;
        bottom: 0;
        z-index: 100;
        background: linear-gradient(180deg, rgba(15, 19, 24, 1) 0%, rgba(10, 13, 18, 1) 100%);
        box-shadow: 0 -8px 24px rgba(0, 0, 0, 0.6);
      }
      .cart-subtotal { padding: 0.75rem 0; margin-bottom: 1rem; }
      .cart-buttons { 
        gap: 0.75rem; 
        display: flex;
        flex-direction: row;
      }
      .btn-checkout, .btn-view-cart { 
        flex: 1; 
        padding: 1rem 0.75rem; 
        font-size: 0.9rem;
        font-weight: 700;
        letter-spacing: 0.3px;
        min-height: 50px;
      }
      .btn-checkout {
        background: rgba(255, 255, 255, 1);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      }
      .btn-view-cart {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
      }
    }

    .sidebar { position: fixed; top: 0; height: 100vh; background: var(--panel); border: 1px solid var(--border); box-shadow: none; transition: transform 0.25s cubic-bezier(0.25, 0.46, 0.45, 0.94); z-index: 1100; overflow: hidden;}
    .sidebar-left { left: 0; transform: translateX(-100%); width: 80%; max-width: 320px; }
    .sidebar-left.active { transform: translateX(0); }
    .sidebar-right { right: 0; transform: translateX(100%); width: 90%; max-width: 420px; }
    .sidebar-right.active { transform: translateX(0); }
    .sidebar-header { padding: 1.25rem 1.5rem; border-bottom: 1px solid var(--border); display:flex; justify-content: space-between; align-items: center; }
    .sidebar-title { font-family: 'Inter', sans-serif; font-size: 0.95rem; font-weight: 700; color: rgba(255,255,255,0.9); margin: 0; letter-spacing: 0.04em; text-transform: none; }
    .close-btn { 
      width: 38px; 
      height: 38px; 
      border: none;
      border-radius: 50%;
      background: transparent;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s ease;
      color: rgba(255,255,255,0.6);
      font-size: 1.2rem;
      z-index: 100;
    }

    .close-btn:hover {
      background: transparent;
      color: rgba(255,255,255,0.6);
    }

    .sidebar-content { display:flex; flex-direction:column; height: calc(100% - 60px); overflow: hidden; }
    .sidebar-scrollable { flex:1; overflow-y:auto; overflow-x: hidden; padding: 0 12px 12px; }
    .category-list { list-style: none; padding: 0; margin: 12px 0 0; display:flex; flex-direction:column; gap: 4px; }
    .category-link { position: relative; display:flex; align-items:center; gap:10px; padding:.75rem .9rem; border-radius: 8px; color: var(--text-secondary); background: transparent; border: none; box-shadow: inset 0 0 0 1px rgba(255,255,255,0.08); text-decoration: none; }
    .category-link:hover { background: transparent; color: var(--text-secondary); }
    .category-icon { width: 20px; color: var(--text-secondary); opacity:.9; }
    /* Hide scrollbar for category list */
    #leftSidebar .sidebar-scrollable { scrollbar-width: none; -ms-overflow-style: none; }
    #leftSidebar .sidebar-scrollable::-webkit-scrollbar { width: 0; height: 0; }
    #leftSidebar .sidebar-scrollable::-webkit-scrollbar-thumb { background: transparent; }
    /* Slight extra left room */
    #leftSidebar .category-list { margin-left: 8px; }
    
    /* Sidebar Structure - Categories Scrollable with Fixed Login Pocket */
    #leftSidebar .sidebar-content {
      display: flex;
      flex-direction: column;
      height: calc(100vh - 80px); /* Account for header */
    }
    
    #leftSidebar .sidebar-scrollable {
      flex: 1;
      overflow-y: auto;
      padding-bottom: 20px;
    }
    
    /* Sidebar Login Pocket - Fixed at Bottom */
    .sidebar-login-section {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(21, 25, 34, 0.95);
      padding: 0.5rem 8px;
      border-top: 1px solid var(--border);
      z-index: 100;
      backdrop-filter: blur(8px);
    }
    
    .sidebar-login-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.4rem;
      padding: 0.6rem 0.8rem;
      background: rgba(229, 231, 235, 0.8);
      color: #000;
      text-decoration: none;
      border: 1px solid rgba(229, 231, 235, 0.4);
      border-radius: 6px;
      font-weight: 600;
      font-size: 0.85rem;
      width: 100%;
      box-sizing: border-box;
      transition: all 0.2s ease;
    }
    
    .sidebar-login-btn:hover {
      background: rgba(229, 231, 235, 0.9);
      border-color: rgba(229, 231, 235, 0.6);
      transform: translateY(-1px);
    }
    
    .sidebar-login-btn i {
      font-size: 0.8rem;
    }
    
    
    main{ padding: 160px 2rem 3rem; max-width:1200px; margin:0 auto; }
    .product-layout{ display:grid; grid-template-columns: 1.2fr 1fr; gap: 2rem; align-items:start; }
    .product-media{ background: rgba(21,25,34,0.5); border:1px solid rgba(255,255,255,0.08); border-radius: 8px; padding: 1.5rem; display:flex; align-items:center; justify-content:center; min-height: 360px; box-shadow: none; position: relative; overflow: hidden; cursor: zoom-in; }
    .product-media img{ max-width:100%; height:auto; object-fit:contain; border-radius: 4px; transition: opacity 0.35s ease-out, transform 0.35s ease-out; }
    
    /* Image Zoom Styles */
    
    .zoom-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.95);
      backdrop-filter: blur(8px);
      z-index: 9999;
      display: none;
      align-items: center;
      justify-content: center;
      cursor: zoom-out;
    }
    
    .zoom-overlay.active {
      display: flex;
    }
    
    .zoomed-image-container {
      position: relative;
      max-width: 90vw;
      max-height: 90vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .zoomed-image {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
      border-radius: 8px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
    }
    
    .zoom-close {
      position: absolute;
      top: 20px;
      right: 20px;
      width: 50px;
      height: 50px;
      background: rgba(229, 231, 235, 0.9);
      border: 2px solid rgba(229, 231, 235, 0.6);
      border-radius: 50%;
      color: #000;
      font-size: 1.2rem;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }
    
    .zoom-close:hover {
      background: rgba(229, 231, 235, 1);
      border-color: rgba(229, 231, 235, 0.8);
      transform: scale(1.1);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.3);
    }
    
    @media (max-width: 768px) {
      .zoom-close {
        top: 15px;
        right: 15px;
        width: 45px;
        height: 45px;
        font-size: 1.1rem;
      }
      
      .zoomed-image-container {
        max-width: 95vw;
        max-height: 95vh;
      }
    }
    
    /* Minimal Human Side Slide Animation */
    .product-media img.slide-out { opacity: 0; transform: translateX(15px) scale(0.98); }
    .product-media img.slide-in { opacity: 1; transform: translateX(0) scale(1); }
    .wishlist-btn{ position:absolute; bottom:12px; right:12px; width:46px; height:46px; display:flex; align-items:center; justify-content:center; border-radius:10px; border:1px solid #2e4d2c; background:#2e4d2c; color:#fff; cursor:pointer; }
    .wishlist-btn i{ color:#fff; font-size:1.2rem; }
    .product-info{ display:flex; flex-direction:column; gap: 1rem; }
    .product-title{ font-size: 2rem; font-weight: 900; letter-spacing:.01em; color: var(--text-primary); line-height: 1.2; margin-bottom: 0.5rem; }
    .pricing-section {
      position: relative;
      margin: 1.5rem 0 1rem 0;
      display: flex;
      align-items: flex-start;
      gap: 1rem;
    }
    .price-display {
      display: flex;
      flex-direction: column;
      gap: 0.3rem;
    }
    .current-price {
      font-size: 1.8rem;
      font-weight: 900;
      color: #c7a96a;
      letter-spacing: -0.01em;
    }
    .original-price {
      font-size: 0.9rem;
      text-decoration: line-through;
      color: rgba(255,255,255,0.4);
      font-weight: 500;
    }
    .savings-text {
      color: #c7a96a;
      font-weight: 600;
      margin-top: 0.2rem;
    }
    .stock-pill {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0;
      background: transparent;
      border: none;
      border-radius: 0;
      margin-top: 0.75rem;
    }
    .stock-text {
      font-size: 0.85rem;
      font-weight: 600;
      color: rgba(255,255,255,0.55);
    }
    .stock-text.low {
      color: #f59e0b;
    }
    .stock-text.out {
      color: #ef4444;
    }
    .variation-box {
      transition: all 0.2s ease !important;
    }


    .variation-box.active {
      border-color: rgba(200,200,200,0.9) !important;
      background: rgba(220,220,220,0.85) !important;
      color: #000000 !important;
      font-weight: 700 !important;
    }

    .variation-box:disabled { 
      opacity: 0.4; 
      cursor: not-allowed; 
      pointer-events: none; 
    }

    .variation-box[style*="display: none"] { 
      display: none !important; 
    }
    
    /* Hide stock badge */
    .variation-stock-badge {
      display: none !important;
    }
    .add-to-cart-btn{ flex:1; padding:.8rem 1rem; border-radius:10px; border:1px solid rgba(255,255,255,0.35); background: rgba(255,255,255,0.85); color:#111; font-weight:600; text-decoration:none; text-align:center; box-shadow: 0 8px 18px rgba(0,0,0,0.22); cursor: pointer; display: flex; align-items: center; justify-content: center; }
    .buy-now-btn{ flex:1; padding:.8rem 1rem; border-radius:10px; border:1px solid rgba(255, 255, 255, 0.2); background: transparent; color: rgba(255, 255, 255, 0.8); font-weight:500; text-decoration:none; text-align:center; display: flex; align-items: center; justify-content: center; gap: 0.5rem; cursor: pointer; }
    .actions{ display: flex; flex-direction: column; gap: 0.75rem; align-items: stretch; margin-top: 1.5rem; }
    
    .description{ margin-top: .5rem; padding: 0; background: transparent; border: none; border-radius: 0; color: var(--text-secondary); }
    .desc-box{ position: relative; }
    .desc-content{ max-height: 6.5em; overflow: hidden; line-height: 1.6; }
    .desc-content.expanded{ max-height: none; }
    .desc-toggle{ margin-top: .5rem; padding: .6rem 1rem; border-radius: 10px; border: 1px solid rgba(255,255,255,0.12); background: rgba(21,25,34,0.6); color: var(--text-primary); cursor: pointer; }
    .related{ margin-top: 2.5rem; }
    .related h3{ font-size:1.2rem; font-weight:800; margin-bottom: 1rem; }
    .products-grid{ display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1rem; }
    /* Reviews - Clean & Simple */
    .reviews{ margin-top: 2rem; }
    .reviews h3{ font-size: 1.2rem; font-weight: 600; margin-bottom: 1rem; color: var(--text-primary); }
    
    .review-item{ 
      background: rgba(255, 255, 255, 0.02); 
      border: 1px solid rgba(255, 255, 255, 0.08); 
      border-radius: 8px; 
      padding: 0.75rem; 
      margin-bottom: 0.75rem; 
      transition: all 0.2s ease;
    }
    .review-item:hover{ background: rgba(255, 255, 255, 0.04); }
    
    .review-meta{ 
      display: flex; 
      align-items: center; 
      gap: 0.5rem; 
      margin-bottom: 0.5rem; 
      font-size: 0.85rem;
    }
    .review-meta .reviewer-name{ 
      font-weight: 600; 
      color: var(--text-primary);
    }
    .review-meta .rating{ 
      color: #f4c430; 
      font-size: 0.8rem;
    }
    
    .review-text{ 
      color: var(--text-primary); 
      font-size: 0.9rem; 
      line-height: 1.5; 
      margin-bottom: 0.4rem;
    }
    
    .admin-reply{ 
      margin-top: 0.75rem; 
      padding: 0.6rem 0.75rem; 
      background: rgba(255, 255, 255, 0.85);
      border: 1px solid rgba(255, 255, 255, 0.35);
      border-radius: 8px;
      box-shadow: 0 6px 14px rgba(0, 0, 0, 0.18);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      border-left: 3px solid rgba(255, 255, 255, 0.6);
      transition: all 0.3s ease;
      overflow: visible;
      min-height: auto;
    }
    
    .reply-meta{ 
      display: flex; 
      align-items: center; 
      gap: 0.4rem; 
      margin-bottom: 0.4rem; 
      font-size: 0.8rem; 
      font-weight: 600; 
      color: #111318;
    }
    
    .reply-text{ 
      color: #111318; 
      font-size: 0.85rem; 
      line-height: 1.4;
      word-wrap: break-word;
      overflow-wrap: break-word;
    }
    
    .admin-reply .read-more-link{ 
      color: #666; 
      font-size: 0.85rem; 
      cursor: pointer; 
      text-decoration: underline; 
      margin-left: 0.5rem;
      display: inline-block;
      margin-top: 0.25rem;
    }
    .admin-reply .read-more-link:hover{ 
      color: #333; 
    }
    
    .read-more-link{ 
      color: rgba(255, 255, 255, 0.6); 
      font-size: 0.85rem; 
      cursor: pointer; 
      text-decoration: underline; 
      margin-left: 0.5rem;
    }
    .read-more-link:hover{ color: rgba(255, 255, 255, 0.8); }
    .review-form{ 
      margin-top: 2rem; 
      background: rgba(255, 255, 255, 0.02); 
      border: 1px solid rgba(255, 255, 255, 0.08); 
      border-radius: 12px; 
      padding: 1.5rem;
    }
    
    .review-form-label{ 
      display: block; 
      color: var(--text-primary); 
      font-size: 0.95rem; 
      font-weight: 500; 
      margin-bottom: 0.5rem;
    }
    
    .review-textarea{ 
      width: 100%; 
      min-height: 100px; 
      border: 1px solid rgba(255, 255, 255, 0.15); 
      border-radius: 8px; 
      background: rgba(255, 255, 255, 0.05); 
      color: var(--text-primary); 
      padding: 1rem; 
      resize: vertical; 
      outline: none; 
      font-size: 0.95rem; 
      line-height: 1.6; 
      transition: all 0.2s ease;
    }
    .review-textarea:focus{ 
      border-color: rgba(255, 255, 255, 0.3); 
      background: rgba(255, 255, 255, 0.08); 
      box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.05);
    }
    .review-textarea::placeholder{ color: rgba(255, 255, 255, 0.4); }
    
    .review-actions{ 
      display: flex; 
      justify-content: flex-end; 
      margin-top: 1rem;
    }
    .review-submit{ 
      padding: 0.75rem 1.5rem; 
      border-radius: 10px; 
      background: rgba(255, 255, 255, 0.85);
      color: #111318;
      border: 1px solid rgba(255, 255, 255, 0.35);
      box-shadow: 0 8px 18px rgba(0, 0, 0, 0.22);
      font-weight: 700; 
      font-size: 0.9rem; 
      cursor: pointer; 
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      letter-spacing: 0.025em;
    }
    .review-submit:hover{ 
      background: rgba(255, 255, 255, 0.92);
      border-color: rgba(255, 255, 255, 0.45);
      box-shadow: 0 10px 22px rgba(0, 0, 0, 0.25);
      transform: translateY(-1px);
    }
    
    .rating-input{ 
      display: flex; 
      align-items: center; 
      gap: 0.5rem; 
      margin: 1rem 0;
    }
    .rating-input .star{ 
      cursor: pointer; 
      color: rgba(255, 255, 255, 0.3); 
      font-size: 1.5rem; 
      transition: all 0.2s ease;
    }
    .rating-input .star:hover{ 
      color: #f4c430; 
      transform: scale(1.1);
    }
    .rating-input .star.active{ color: #f4c430; }
    
    .rating-text{ 
      color: rgba(255, 255, 255, 0.7); 
      font-size: 0.9rem; 
      margin-left: 0.5rem; 
      font-weight: 500;
    }
    
    .reviews-toggle{ 
      margin: 1rem 0; 
      padding: 0; 
      border: none; 
      background: transparent; 
      color: rgba(255, 255, 255, 0.7); 
      cursor: pointer; 
      font-weight: 400; 
      font-size: 0.9rem; 
      text-decoration: underline;
      transition: color 0.2s ease;
    }
    .reviews-toggle:hover{ 
      color: rgba(255, 255, 255, 0.9); 
    }
    .product-card{ position:relative; background: rgba(21,25,34,0.5); border-radius: 8px; overflow: hidden; display:flex; flex-direction:column; box-shadow: none; border: none; }
    .product-card .product-image-container{ display:flex; align-items:center; justify-content:center; aspect-ratio: 1 / 1; padding: .75rem; background: rgba(0,0,0,0.15); }
    .product-card img{ max-width:100%; height:auto; object-fit:contain; }
    .product-card .product-details{ padding: .8rem; display:flex; flex-direction:column; gap:.4rem; }
    .product-card .name{ font-weight:600; }
    .product-card .meta{ display:flex; align-items:center; justify-content:space-between; }
    .product-card .meta .price{ font-weight:800; color: var(--accent); }
    .product-card .actions{ padding:.8rem; display:flex; gap:.5rem; }
    .btn-view, .btn-cart{ padding:.6rem .85rem; border-radius:10px; border:none; background: var(--panel-2); color:var(--text-secondary); text-decoration:none; text-align:center; }
    .btn-view{ background: #2e4d2c; color:#fff; }
    footer{ margin-top: 2rem; }
    /* Compact related products section */
    .related { margin-top: 1.5rem; }
    .related h3 {
      font-size: 1.1rem;
      line-height: 1.2;
      font-weight: 700;
      letter-spacing: 0;
      color: var(--text-primary);
      margin: 0 0 .75rem 0;
    }
    /* Clean Related Products Grid */
    .related .products-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 160px));
      gap: 0.75rem;
      justify-content: start;
      align-items: start;
    }
    
    .related .product-card { 
      background: rgba(21,25,34,0.5);
      border-radius: 6px;
      overflow: hidden;
      transition: none;
      height: 100%;
      display: flex;
      flex-direction: column;
      border: none;
    }
    
    .related .product-card:hover {
      transform: none;
      box-shadow: none;
    }
    
    .related .product-card .product-image-container {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 100%;
      aspect-ratio: 1 / 1;
      padding: 0.5rem;
      background: rgba(0,0,0,0.15);
    }
    
    .related .product-card img { 
      max-width: 100%; 
      max-height: 100%; 
      object-fit: contain; 
      border-radius: 4px;
    }
    
    .related .product-card .product-details { 
      padding: 0.5rem 0.6rem;
      text-align: center;
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      gap: 0.3rem;
    }
    
    .related .product-card .product-details h3 {
      font-size: 0.75rem;
      font-weight: 600;
      margin: 0;
      color: var(--text-primary);
      line-height: 1.2;
      overflow: hidden;
      text-overflow: ellipsis;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      line-clamp: 2;
      -webkit-box-orient: vertical;
    }
    
    .related .product-card .product-details .price {
      font-size: 0.8rem;
      font-weight: 700;
      color: #4ade80;
      margin-top: auto;
    }
    
    .related .product-card .actions { display: none; }
    .related .price-badge-small { display: none; }

    /* Subtle entrance animations */
    .reveal{ opacity: 0; transform: translateY(8px); transition: opacity .28s ease, transform .28s ease; }
    .reveal.show{ opacity: 1; transform: translateY(0); }
    .reveal-scale{ opacity: 0; transform: scale(.98); transition: opacity .28s ease, transform .28s ease; }
    .reveal-scale.show{ opacity: 1; transform: scale(1); }


    /* Responsive Related Products */
    @media (max-width: 768px) {
      .related .products-grid {
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
        max-width: 400px;
        margin: 0 auto;
      }
      
      .related .product-card .product-image-container {
        padding: 0.75rem;
      }
      
      .related .product-card .product-details {
        padding: 0.75rem;
      }
      
      .related .product-card .product-details h3 {
        font-size: 0.8rem;
        -webkit-line-clamp: 2;
        line-clamp: 2;
      }
      
      .related .product-card .product-details .price {
        font-size: 0.9rem;
      }
    }

    @media (max-width: 480px) {
      .related .products-grid {
        gap: 0.75rem;
        max-width: 350px;
        margin: 0 auto;
      }
    }

      
      /* Tighter spacing for product info on mobile */
      .product-info {
        gap: 0.75rem !important;
      }
      
      .product-title {
        margin-bottom: 0.5rem !important;
      }
      
      .price-stock {
        margin: 0.5rem 0 !important;
      }
      
      .description {
        margin-top: 0.75rem !important;
        margin-bottom: 0.75rem !important;
      }
      
      .rating {
        margin: 0.5rem 0 !important;
      }
      
      .dropdown-variations-container {
        margin: 0.75rem 0 0.5rem 0 !important;
        gap: 0.75rem !important;
      }
      
      .variation-group {
        gap: 0.4rem !important;
      }
      
      .actions {
        margin-top: 1rem !important;
        gap: 0.75rem !important;
      }
      
      /* Reduce padding in product info container */
      .product-layout > div:last-child {
        padding: 1rem !important;
      }
      
      /* Constrain product layout to prevent overflow */
      .product-layout {
        padding: 0.5rem !important;
        max-width: 100vw !important;
        overflow-x: hidden !important;
        box-sizing: border-box !important;
      }
      
      .product-info {
        max-width: 100% !important;
        padding: 0 0.5rem !important;
        box-sizing: border-box !important;
        overflow-x: hidden !important;
      }
      
      /* Fix dropdown on mobile - prevent extending beyond screen */
      .dropdown-variations-container {
        display: flex !important;
        flex-direction: column !important;
        flex-wrap: nowrap !important;
        width: 100% !important;
        max-width: 100% !important;
        padding: 0 !important;
        margin: 1rem 0 0.5rem 0 !important;
        box-sizing: border-box !important;
        gap: 0.5rem !important;
      }
      
      .variation-dropdown {
        flex: none !important;
        min-width: 100% !important;
        max-width: 100% !important;
        width: 100% !important;
        margin-bottom: 0 !important;
        box-sizing: border-box !important;
      }
      
      .variation-select {
        font-size: 0.85rem !important;
        padding: 0.6rem 2rem 0.6rem 0.75rem !important;
        background-position: right 0.75rem center !important;
        max-width: 100% !important;
        width: 100% !important;
        box-sizing: border-box !important;
        overflow: hidden !important;
        border: 1px solid var(--border) !important;
      }
      
      /* Prevent dropdown options from extending beyond viewport */
      .variation-select option {
        max-width: 100% !important;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
    }

    @media (max-width: 900px){
      .product-layout{ grid-template-columns: 1fr; }
      main{ padding-top: 140px; }
      /* Footer responsive parity with Home */
      .site-footer .newsletter-wrap{ grid-template-columns: 1fr !important; gap: .9rem !important; }
      .site-footer .newsletter-form{ margin-left: 0 !important; max-width: 100% !important; width: 100% !important; display: grid !important; grid-template-columns: 1fr !important; gap: .6rem !important; }
      .site-footer .newsletter-input{ width: 100% !important; }
      .site-footer .newsletter-btn{ width: 100% !important; }
      .site-footer .footer-bottom{ flex-direction: column !important; gap: .5rem !important; text-align: center !important; justify-content: center !important; }
      .site-footer .footer-bottom-links{ justify-content: center !important; }
      .site-footer .footer-socials{ justify-content: center !important; }
    }

    /* Tablet optimizations */
    @media (max-width: 768px) {
      .navbar-container { padding: 0.65rem 1.25rem; }
      .logo { font-size: 1.5rem; }
      .nav-btn { padding: 0.5rem; font-size: 1rem; }
      .product-layout { grid-template-columns: 1fr; gap: 1.5rem; }
      main { padding: 130px 1.25rem 2rem; }
    }

    /* Phone optimizations */
    @media (max-width: 580px) {
      .navbar-container { padding: 0.6rem 1rem; }
      .logo { font-size: 1.3rem; }
      .nav-btn { padding: 0.4rem; font-size: 1rem; }
      .nav-btn.profile { width: 36px; height: 36px; }
      .cart-badge, .wishlist-badge { width: 20px; height: 20px; font-size: 0.7rem; }
      
      main { padding: 120px 1rem 2rem; }
      
      .product-layout { gap: 1.25rem; }
      
      /* Product Media */
      .product-media { 
        min-height: 280px; 
        padding: 1.25rem; 
        margin-bottom: 1rem;
      }
      .product-media img { max-height: 260px; }
      .wishlist-btn { bottom: 8px; right: 8px; width: 44px; height: 44px; }
      
      /* Image Variations Strip - Better Touch */
      .image-variations-container { 
        margin-top: 0.5rem !important; 
      }
      .image-variations-strip { 
        gap: 0.5rem !important; 
        padding: 0.35rem 0.1rem 0.35rem !important; 
      }
      .image-variation-item { 
        min-width: 72px !important; 
      }
      .image-variation-item > div { 
        width: 72px !important; 
        height: 72px !important; 
      }
      
      /* Product Info */
      .product-title { font-size: 1.35rem; line-height: 1.3; margin-bottom: 0.5rem; }
      
      .price-stock { 
        flex-direction: column; 
        align-items: flex-start; 
        gap: 0.65rem; 
        margin-bottom: 0.75rem;
      }
      .price-badge { 
        padding: 0.5rem 0.75rem; 
        font-size: 1rem;
      }
      .price-badge .original-price { font-size: 0.8rem; }
      .price-badge .discount-percent { font-size: 0.75rem; }
      
      .stock-indicator { 
        padding: 0.45rem 0.7rem; 
        font-size: 0.85rem;
        margin-bottom: 0;
      }
      
      /* Description */
      .description { margin-top: 0.75rem; margin-bottom: 0.75rem; }
      .desc-content { font-size: 0.95rem; line-height: 1.5; }
      .desc-toggle { 
        padding: 0.65rem 1rem; 
        font-size: 0.9rem;
        margin-top: 0.6rem;
      }
      
      /* Rating */
      .rating { 
        gap: 0.4rem; 
        margin-top: 0.6rem;
        margin-bottom: 0.75rem;
      }
      .rating .stars { gap: 3px; font-size: 1rem; }
      .rating .value { font-size: 0.9rem; }
      
      /* Box-style Variations */
      .dropdown-variations-container { 
        margin: 0.75rem 0 !important; 
        gap: 0.85rem !important;
      }
      .variation-group label { 
        font-size: 0.75rem !important; 
        margin-bottom: 0.4rem !important;
      }
      .variation-boxes { 
        gap: 0.45rem !important;
      }
      .variation-box { 
        padding: 0.65rem 0.9rem !important; 
        font-size: 0.85rem !important;
        min-width: 56px !important;
      }
      
      /* Actions: stack buttons vertically on mobile */
      .actions { 
        flex-direction: column; 
        align-items: stretch;
        gap: 0.75rem; 
        margin-top: 1rem;
      }
      .add-to-cart-btn { 
        flex: 1; 
        padding: 0.85rem 1rem; 
        font-size: 0.98rem;
        font-weight: 600;
      }
      .buy-now-btn {
        flex: 1;
        padding: 0.85rem 1rem;
        font-size: 0.98rem;
      }
      .back-link { 
        flex: 1;
        padding: 0.8rem 1rem; 
        font-size: 0.95rem;
        text-align: center;
        white-space: nowrap;
      }
      
      
      /* Reviews */
      .reviews { margin-top: 1.5rem; }
      .reviews h3 { font-size: 1.1rem; }
      .review-item { padding: 0.85rem; }
      .review-form { padding: 0.85rem; }
      .review-textarea { min-height: 88px; padding: 0.65rem; font-size: 0.95rem; }
      .review-submit { padding: 0.65rem 1.1rem; font-size: 0.95rem; }
      .rating-input .star { font-size: 1.05rem; }
      
      /* Related Products */
      .related { margin-top: 1.75rem; }
      .related h3 { font-size: 1.05rem; margin-bottom: 0.85rem; }
      .related .products-grid { 
        grid-template-columns: repeat(2, 1fr);
        gap: 0.75rem;
      }
    }

    @media (max-width: 400px) {
      .navbar-container { padding: 0.55rem 0.85rem; }
      .logo { font-size: 1.25rem; }
      main { padding: 115px 0.85rem 1.75rem; }
      
      .product-media { min-height: 240px; padding: 1rem; }
      .product-media img { max-height: 220px; }
      
      .image-variation-item { min-width: 64px !important; }
      .image-variation-item > div { width: 64px !important; height: 64px !important; }
      
      .product-title { font-size: 1.2rem; }
      .price-badge { padding: 0.45rem 0.65rem; font-size: 0.95rem; }
      .stock-indicator { padding: 0.4rem 0.6rem; font-size: 0.8rem; }
      .desc-content { max-height: 5em; font-size: 0.9rem; }
      .desc-toggle { padding: 0.6rem 0.9rem; font-size: 0.85rem; }
      .add-to-cart-btn { padding: 0.85rem 1.1rem; font-size: 0.95rem; width: 100%; }
      .buy-now-btn { padding: 0.8rem 1.1rem; font-size: 0.9rem; width: 100%; }
      
      
      .related .products-grid { gap: 0.65rem; }
      .related .product-card .product-details h3 { font-size: 0.7rem; }
    }

    /* Toast animations */
    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    @keyframes slideOut {
      from {
        transform: translateX(0);
        opacity: 1;
      }
      to {
        transform: translateX(400px);
        opacity: 0;
      }
    }

  </style>
</head>
<body>
  <!-- Global Loading Overlay -->
  <div id="globalLoadingOverlay" class="global-loading-overlay">
    <div class="global-loading-spinner">
      <svg class="cart" role="img" aria-label="Shopping cart line animation" viewBox="0 0 128 128" width="128px" height="128px" xmlns="http://www.w3.org/2000/svg">
        <g fill="none" stroke-linecap="round" stroke-linejoin="round" stroke-width="8">
          <g class="cart__track" stroke="hsla(0,10%,10%,0.1)">
            <polyline points="4,4 21,4 26,22 124,22 112,64 35,64 39,80 106,80" />
            <circle cx="43" cy="111" r="13" />
            <circle cx="102" cy="111" r="13" />
          </g>
          <g class="cart__lines" stroke="currentColor">
            <polyline class="cart__top" points="4,4 21,4 26,22 124,22 112,64 35,64 39,80 106,80" stroke-dasharray="338 338" stroke-dashoffset="-338" />
            <g class="cart__wheel1" transform="rotate(-90,43,111)">
              <circle class="cart__wheel-stroke" cx="43" cy="111" r="13" stroke-dasharray="81.68 81.68" stroke-dashoffset="81.68" />
            </g>
            <g class="cart__wheel2" transform="rotate(90,102,111)">
              <circle class="cart__wheel-stroke" cx="102" cy="111" r="13" stroke-dasharray="81.68 81.68" stroke-dashoffset="81.68" />
            </g>
          </g>
        </g>
      </svg>
    </div>
    <div class="global-loading-text">Loading product details...</div>
    <div class="global-loading-subtext">Preparing your shopping cart</div>
  </div>

  <header class="navbar">
    <div class="navbar-top">
      <div class="navbar-container">
        <a href="/" class="logo">CiTi<i class="fas fa-shopping-cart logo-cart" aria-hidden="true"></i>Plug</a>
        <div class="nav-actions">
          {% if session and session.get('user_id') %}
            <div class="user-info">
              <a href="/profile" class="nav-btn profile" title="Profile"><i class="fas fa-user"></i></a>
              <span class="user-welcome">{{ session.get('username', 'User') }}</span>
            </div>
          {% else %}
            <a href="/login" class="nav-btn profile" title="Login"><i class="fas fa-user"></i></a>
          {% endif %}
        </div>
      </div>
    </div>
    <div class="navbar-bottom">
      <div class="navbar-container">
        <div class="nav-actions">
          <button class="menu-btn" onclick="document.getElementById('leftSidebar')?.classList.add('active');document.getElementById('overlay')?.classList.add('active')">
            <i class="fas fa-bars"></i>
          </button>
        </div>
        <div class="nav-center"></div>
        <div class="nav-actions">
          <a href="/profile#wishlist" class="nav-btn wishlist" aria-label="Wishlist" style="position:relative">
            <i class="fas fa-heart"></i>
            <span class="wishlist-badge" id="wishlistBadge">0</span>
          </a>
          <button class="nav-btn cart" onclick="openMiniCart()" aria-label="Open Cart">
            <i class="fas fa-shopping-cart"></i>
            <span class="cart-badge" id="cartBadge">{{ (session.cart|default({})).values()|map(attribute='quantity')|sum if session and session.cart else 0 }}</span>
          </button>
        </div>
      </div>
    </div>
  </header>

  <!-- Overlay and Sidebars -->
  <div id="overlay" class="overlay" onclick="closeAllSidebars()"></div>
  <aside id="leftSidebar" class="sidebar sidebar-left" aria-label="Categories">
    <div class="sidebar-header">
      <h3 class="sidebar-title">Categories</h3>
      <button id="closeLeft" class="close-btn" aria-label="Close"><i class="fas fa-xmark"></i></button>
    </div>
    <div class="sidebar-content">
      <div class="sidebar-scrollable">
        <ul class="category-list">
          <li class="category-item">
            <a class="category-link" href="/">
              <i class="fas fa-house category-icon"></i>Home
            </a>
          </li>
          {% for c in categories %}
          <li class="category-item"><a class="category-link" href="/viewall?category={{ c.id }}"><i class="fas fa-tag category-icon"></i>{{ c.name }}</a></li>
          {% endfor %}
          <li class="category-item">
            <a href="/viewall?category=uncategorized" class="category-link">
              <i class="fas fa-box-open category-icon"></i>Uncategorized
            </a>
          </li>
        </ul>
      </div>
      
    </div>
  </aside>

  <!-- Modern Mini Cart Overlay -->
  <div class="mini-cart-overlay" id="miniCartOverlay" onclick="closeMiniCart()"></div>
  
  <!-- Modern Mini Cart Sidebar -->
  <div class="mini-cart" id="miniCart">
    <div class="mini-cart-header">
      <div class="mini-cart-title">
        {% if cart_items %}
          {% set total = namespace(value=0) %}
          {% for item in cart_items %}
            {% set total.value = total.value + (item.price * item.quantity) %}
          {% endfor %}
          <div class="cart-total-display" style="color: rgba(255, 255, 255, 0.9); font-size: 0.9rem; font-weight: 600; margin-bottom: 0.5rem;">
            Total: RWF {{ '{:,.0f}'.format(total.value) }}
          </div>
        {% endif %}
        <div class="cart-header-buttons">
          <a href="/addtocart" class="btn-view-cart-header"><i class="fas fa-shopping-cart"></i> cart</a>
          <button class="btn-checkout-header" onclick="window.location.href='/checkout'"><i class="fas fa-credit-card"></i> checkout</button>
        </div>
      </div>
      <button class="mini-cart-close" onclick="closeMiniCart()" aria-label="Close cart">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <div class="mini-cart-body">
      {% if not cart_items %}
        <!-- Empty State -->
        <div class="mini-cart-empty">
          <div class="empty-icon">
            <i class="fas fa-shopping-bag"></i>
          </div>
          <h3>Your cart is empty</h3>
          <p>Add some products to get started!</p>
          <button class="btn-continue-shopping" onclick="closeMiniCart()">
            <i class="fas fa-arrow-left"></i>
            Continue Shopping
          </button>
        </div>
      {% else %}
        <!-- Cart Items -->
        <div class="mini-cart-items">
          {% set total = namespace(value=0) %}
          {% for item in cart_items %}
            {% set subtotal = item.price * item.quantity %}
            {% set total.value = total.value + subtotal %}
            <div class="mini-cart-item" data-cart-id="{{ item.id }}" style="cursor: pointer;" onclick="navigateToProduct(event, '{{ item.product_id }}')">
              <a href="/product/{{ item.product_id }}" class="item-image" style="display: block; text-decoration: none;">
                <img src="{{ item.image }}" alt="{{ item.name }}" loading="lazy" onerror="this.src='/static/images/default-product.jpg'; this.onerror=null;">
              </a>
              <div class="item-details">
                <a href="/product/{{ item.product_id }}" class="item-name" style="color: inherit; text-decoration: none; display: block; cursor: pointer;">
                  <h4 style="margin: 0;">{{ item.name }}</h4>
                </a>
                {% if item.variations %}
                  <p class="item-variant">{{ item.variations|fmtvars }}</p>
                {% endif %}
                <div class="item-price-qty">
                  <span class="item-price">RWF {{ "{:,.0f}".format(item.price) }}</span>
                  <div class="item-quantity">
                    <span style="font-size: 0.75rem; color: rgba(255,255,255,0.6); margin-right: 0.3rem;">Qty:</span>
                    <span class="qty-simple">{{ item.quantity }}</span>
                  </div>
                </div>
              </div>
              <button class="item-remove" onclick="removeCartItem('{{ item.id }}')" aria-label="Remove item">
                <i class="fas fa-times"></i>
              </button>
            </div>
          {% endfor %}
        </div>
      {% endif %}
    </div>

  </div>

  <main>
    {% include 'flash_messages.html' %}
    
    
    <section class="product-layout reveal">
      <div>
        <div class="product-media" style="position:relative;" onclick="openImageZoom()">
          <img id="mainProductImage" src="{{ product.image }}" alt="{{ product.name }}" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'600\' height=\'400\'%3E%3Crect fill=\'%23eee\' width=\'600\' height=\'400\'/%3E%3Ctext x=\'50%25\' y=\'50%25\' dominant-baseline=\'middle\' text-anchor=\'middle\' fill=\'%23999\' font-size=\'20\' font-family=\'Inter, sans-serif\'%3ENo image%3C/text%3E%3C/svg%3E'">
          <button id="wishlistBtn" class="wishlist-btn {% if in_wishlist %}active{% endif %}" type="button" data-in="{{ '1' if in_wishlist else '0' }}" onclick="event.stopPropagation(); event.preventDefault(); toggleWishlist('{{ product.id }}'); return false;">
            <i class="{% if in_wishlist %}fas{% else %}far{% endif %} fa-heart"></i>
          </button>
        </div>
        
        <!-- Image Variations Thumbnails -->
        {% if image_variations and image_variations|length > 0 %}
        <div class="image-variations-container" style="margin-top: .75rem;">
          <div class="image-variations-strip" style="display: flex; gap: .65rem; overflow-x: auto; padding: .25rem .1rem; scroll-snap-type: x mandatory; -webkit-overflow-scrolling: touch;">
            {% for img_var in image_variations %}
            <div class="image-variation-item" data-img-var-id="{{ img_var.id }}" data-stock="{{ img_var.stock }}" data-name="{{ img_var.name }}" style="display:flex; flex-direction:column; align-items:center; min-width: 84px; position:relative; cursor: pointer;" onclick="selectImageVariation('{{ img_var.id }}','{{ img_var.img_url }}', '{{ img_var.name }}', '{{ img_var.description }}', '{{ img_var.stock }}', this)" title="{{ img_var.description }}">
              <div style="width:84px; height:84px; border:none; border-radius:10px; overflow:hidden; background: var(--panel-2); transition: none; opacity:.9; scroll-snap-align:start; box-shadow:none!important; outline:none!important; position:relative;">
                <img src="{{ img_var.img_url }}" alt="{{ img_var.description }}" style="width:100%; height:100%; object-fit:cover; display:block;" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'100\' height=\'100\'%3E%3Crect fill=\'%23ccc\' width=\'100\' height=\'100\'/%3E%3C/svg%3E'">
                <div class="sold-out-badge" style="display:none; position:absolute; top:50%; left:50%; transform:translate(-50%,-50%) rotate(-15deg); background:rgba(220,38,38,0.95); color:#fff; font-size:0.7rem; font-weight:700; text-transform:uppercase; padding:4px 12px; border-radius:4px; letter-spacing:1px; z-index:10; border:2px solid rgba(255,255,255,0.9); box-shadow:0 2px 8px rgba(0,0,0,0.4);">SOLD OUT</div>
                <div class="stock-badge" style="display:none; position:absolute; top:6px; right:6px; background:rgba(0,0,0,0.75); color:rgba(255,255,255,0.95); font-size:0.65rem; font-weight:600; padding:3px 7px; border-radius:4px; z-index:6; backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); line-height:1;"></div>
              </div>
            </div>
            {% endfor %}
          </div>
        </div>
        {% endif %}
      </div>
      <div class="product-info">
        <!-- Product Title - Bold & Large -->
        <h1 class="product-title">{{ product.name }}</h1>
        <div id="variantSubtitle" style="display:none; margin:.15rem 0 .6rem 0; font-size:.9rem; color:var(--text-secondary); font-weight:500;"></div>
        
        <!-- Star Rating - Close to Title -->
        <div class="rating" aria-label="Product rating">
          {% if product.rating and product.rating > 0 %}
            <div class="stars">
              {% set r = product.rating %}
              {% set full = (r // 1) | int %}
              {% set half = 1 if (r - full) >= 0.5 and full < 5 else 0 %}
              {% set empty = 5 - full - half %}
              {% for _ in range(full) %}<i class="fa-solid fa-star"></i>{% endfor %}
              {% if half %}<i class="fa-solid fa-star-half-stroke"></i>{% endif %}
              {% for _ in range(empty) %}<i class="fa-regular fa-star"></i>{% endfor %}
            </div>
          {% endif %}
        </div>
        
        <!-- Pricing Block with Better Hierarchy -->
        <div class="pricing-section">
          <div class="price-display">
            {% if product.discount and product.discount > 0 %}
              {% set discounted_price = product.price * (1 - product.discount/100) %}
              <span class="current-price">RWF {{ '{:,.0f}'.format(discounted_price) }}</span>
              <span class="original-price">RWF {{ '{:,.0f}'.format(product.price) }}</span>
              <span class="savings-text">You save RWF {{ '{:,.0f}'.format(product.price - discounted_price) }}</span>
            {% else %}
              <span class="current-price">RWF {{ '{:,.0f}'.format(product.price) }}</span>
            {% endif %}
          </div>
          {% if product.discount and product.discount > 0 %}
            <span class="discount-badge">-{{ product.discount|int }}%</span>
          {% endif %}
        </div>
        
        <!-- Stock Status Pill Badge -->
        <div class="stock-pill">
          <span class="stock-text {% if product.stock <= 5 and product.stock > 0 %}low{% elif product.stock <= 0 %}out{% endif %}">{{ product.stock }} left in stock</span>
        </div>
        
        <!-- Product Description -->
        <div class="description">
          {% if product.description %}
            <div class="desc-box">
              <div id="descContent" class="desc-content">{{ product.description|safe }}</div>
              <button id="descToggle" class="desc-toggle" type="button">Read more</button>
            </div>
          {% else %}
            <em style="color:var(--text-secondary)">No description available.</em>
          {% endif %}
        </div>

        <!-- Box-style Variations Selection -->
        {% if dropdown_variations and dropdown_variations|length > 0 %}
        <div class="dropdown-variations-container" style="margin: 1rem 0 0.5rem 0; display: flex; flex-direction: column; gap: 1rem;">
          {% for attr_name, options in dropdown_variations.items() %}
          <div class="variation-group" style="display: flex; flex-direction: column; gap: 0.5rem;">
            <label style="display: block; font-size: 0.8rem; color: #f5f5f5; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">{{ attr_name }}</label>
            <div class="variation-boxes" data-variation-name="{{ attr_name }}" style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
              {% for opt in options %}
              <button type="button" class="variation-box" data-variation-id="{{ opt.id }}" data-stock="{{ opt.stock }}" data-img-var-id="{{ opt.img_var_id if opt.img_var_id else '' }}" data-variation-name="{{ attr_name }}" onclick="selectVariationBox(this)" style="padding: 0.75rem 1.8rem; border-radius: 50px; border: 2px solid rgba(255,255,255,0.25); background: transparent; color: rgba(255,255,255,0.85); font-size: 0.95rem; font-weight: 600; cursor: pointer; transition: all 0.2s ease; min-width: 80px; text-align: center; position: relative; display: flex; align-items: center; justify-content: center; letter-spacing: 0.3px;">
                {{ opt.value }}
              </button>
              {% endfor %}
            </div>
          </div>
          {% endfor %}
        </div>
        {% endif %}

        <!-- Quantity Selector -->
        <div style="margin-top: 1.5rem; margin-bottom: 1rem;" data-product-stock="{{ product.stock }}">
          <label style="display: block; font-size: 0.9rem; font-weight: 600; color: rgba(255,255,255,0.8); margin-bottom: 0.5rem;">Qty:</label>
          <div class="item-quantity" style="display: inline-flex; padding: 0.4rem 0.75rem;">
            <button class="qty-btn" onclick="changeQuantity(-1)" type="button" id="qtyMinusBtn">
              <i class="fas fa-minus"></i>
            </button>
            <span class="qty-value" id="productQuantity">1</span>
            <button class="qty-btn" onclick="changeQuantity(1)" type="button" id="qtyPlusBtn">
              <i class="fas fa-plus"></i>
            </button>
          </div>
          <div id="qtyWarning" style="display: none; font-size: 0.75rem; color: #ef4444; margin-top: 0.5rem;"></div>
        </div>

        <div class="actions">
          {% if product.stock > 0 %}
            <button class="add-to-cart-btn" id="addToCartBtn" onclick="addToCartWithVariations('{{ product.id }}')">Add to Cart</button>
          {% else %}
            <button class="add-to-cart-btn" style="pointer-events:none; opacity:.6">Out of Stock</button>
          {% endif %}
          <button class="buy-now-btn" onclick="buyNow('{{ product.id }}')">
            Buy Now
          </button>
        </div>
        
        <!-- Share Product Section -->
        <div style="margin-top: 1.5rem; padding-top: 1.25rem; border-top: 1px solid var(--border);">
          <p style="font-size: 0.85rem; font-weight: 600; color: rgba(255,255,255,0.7); margin-bottom: 0.6rem; text-transform: uppercase; letter-spacing: 0.06em;">Share</p>
          <div class="share-container">
            <button class="share-link share-whatsapp" onclick="shareOnWhatsApp('{{ product.name }}', '{{ request.url }}')" aria-label="Share on WhatsApp">
              <i class="fab fa-whatsapp"></i>
            </button>
            <button class="share-link share-facebook" onclick="shareOnFacebook('{{ request.url }}')" aria-label="Share on Facebook">
              <i class="fab fa-facebook-f"></i>
            </button>
            <button class="share-link share-instagram" onclick="shareOnInstagram('{{ product.name }}', '{{ request.url }}')" aria-label="Share on Instagram">
              <i class="fab fa-instagram"></i>
            </button>
            <button class="share-link share-copy" onclick="copyProductLink('{{ request.url }}')" aria-label="Copy product link">
              <i class="fas fa-link"></i>
            </button>
          </div>
        </div>
        
        <!-- Hidden inputs to store selected variations -->
        <input type="hidden" id="selectedImageVariations" value=""><!-- stores img_var_id when present -->
        <input type="hidden" id="selectedDropdownVariations" value=""><!-- stores dropdown_var_id when present -->

        <section class="reviews">
          <h3>Reviews</h3>
          {% if reviews and reviews|length > 0 %}
            <div id="reviewsList">
            {% for r in reviews %}
              <div class="review-item{% if loop.index0 >= 2 %} review-hidden{% endif %}"{% if loop.index0 >= 2 %} style="display:none"{% endif %}>
                <div class="review-meta">
                  <i class="fas fa-user"></i>
                  <span>{{ r.username }}</span>
                  {% if r.rating %}<span><i class="fa-solid fa-star" style="color:#f4c430"></i> {{ r.rating }}/5</span>{% endif %}
                </div>
                <div class="review-text truncated" id="review-{{ loop.index0 }}">
                  {% if r.review|length > 20 %}
                    <span class="short-text">{{ r.review[:20] }}...</span>
                    <span class="full-text" style="display:none;">{{ r.review }}</span>
                    <a class="read-more-link no-loading" onclick="toggleReview('review-{{ loop.index0 }}', this)">Read More</a>
                  {% else %}
                    {{ r.review }}
                  {% endif %}
                </div>
                {% if r.reply %}
                  <div class="admin-reply">
                    <div class="reply-meta">
                      <span style="font-weight: 600;">Admin Reply</span>
                    </div>
                    <div class="reply-text truncated" id="reply-{{ loop.index0 }}">
                      {% if r.reply|length > 20 %}
                        <span class="short-text">{{ r.reply[:20] }}...</span>
                        <span class="full-text" style="display:none;">{{ r.reply }}</span>
                        <a class="read-more-link no-loading" onclick="toggleReview('reply-{{ loop.index0 }}', this)">Read More</a>
                      {% else %}
                        {{ r.reply }}
                      {% endif %}
                    </div>
                  </div>
                {% endif %}
              </div>
            {% endfor %}
            </div>
            {% if reviews|length > 2 %}
              <button id="reviewsMoreBtn" class="reviews-toggle" type="button">View more ({{ reviews|length - 2 }} more)</button>
            {% endif %}
          {% else %}
            <em style="color:var(--text-secondary)">No reviews yet.</em>
          {% endif %}

          {% if session and session.get('user_id') %}
            <form class="review-form" method="post" action="{{ url_for('add_review') }}" id="reviewForm">
              <input type="hidden" name="product_id" value="{{ product.id }}"/>
              <input type="hidden" id="ratingValue" name="rating" value="" />
              <label class="review-form-label" style="color: #f5f5f5;">rate it <span style="color:#ef4444">*</span></label>
              <div class="rating-input" id="ratingInput" aria-label="Choose rating from 1 to 5">
                <i class="fa-star fa-regular star" data-val="1"></i>
                <i class="fa-star fa-regular star" data-val="2"></i>
                <i class="fa-star fa-regular star" data-val="3"></i>
                <i class="fa-star fa-regular star" data-val="4"></i>
                <i class="fa-star fa-regular star" data-val="5"></i>
                <span id="ratingText" class="rating-text"></span>
              </div>
              <span id="ratingError" style="display:none;color:#ef4444;font-size:0.85rem;margin-top:-0.75rem;margin-bottom:0.5rem;">please pick a rating</span>
              <label for="review" class="review-form-label">your thoughts</label>
              <textarea required maxlength="500" class="review-textarea" id="review" name="review" placeholder="what do you think about this product?" style="min-height: 80px;"></textarea>
              <div class="review-actions">
                <button type="submit" class="review-submit">share review</button>
              </div>
            </form>
          {% else %}
            <div class="review-form" style="display:flex; align-items:center; justify-content:space-between; gap:.6rem;">
              <div style="color:var(--text-secondary)">Please <a href="{{ url_for('login') }}" style="color:#e5e7eb; text-decoration:underline;">log in</a> to write a review.</div>
            </div>
          {% endif %}
        </section>
      </div>
    </section>

    {% if related_products and related_products|length > 0 %}
    <section class="related">
      <h3>Related products</h3>
      <div class="products-grid">
        {% for p in related_products %}
        <div class="product-card reveal-scale">
          <a class="product-image-container" href="{{ url_for('product_detail', product_id=p.id) }}" aria-label="View {{ p.name }}">
            <img src="{{ p.image }}" alt="{{ p.name }}" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'400\' height=\'280\'%3E%3Crect fill=\'%23222\' width=\'400\' height=\'280\'/%3E%3Ctext x=\'50%25\' y=\'50%25\' dominant-baseline=\'middle\' text-anchor=\'middle\' fill=\'%23666\' font-size=\'16\' font-family=\'Inter, sans-serif\'%3ENo image%3C/text%3E%3C/svg%3E'">
          </a>
          <div class="product-details">
            <h3>{{ p.name }}</h3>
            <div class="price">RWF {{ '{:,.0f}'.format(p.price) }}</div>
          </div>
          <span class="price-badge-small">RWF {{ '{:,.0f}'.format(p.price) }}</span>
        </div>
        {% endfor %}
      </div>
    </section>
    {% endif %}
  </main>

  <!-- Image Zoom Overlay -->
  <div id="zoomOverlay" class="zoom-overlay" onclick="closeImageZoom()">
    <div class="zoomed-image-container" onclick="event.stopPropagation()">
      <img id="zoomedImage" class="zoomed-image" src="" alt="">
      <button class="zoom-close" onclick="closeImageZoom()" aria-label="Close zoom">
        <i class="fas fa-times"></i>
      </button>
    </div>
  </div>

  {% include 'footer.html' %}
  <style>
    /* Footer mobile overrides placed AFTER footer.html to ensure they apply */
    @media (max-width: 900px) {
      footer.site-footer .newsletter-wrap{ grid-template-columns: 1fr !important; gap: .9rem !important; }
      footer.site-footer .newsletter-form{ margin-left: 0 !important; max-width: 100% !important; width: 100% !important; display: grid !important; grid-template-columns: 1fr !important; gap: .6rem !important; }
      footer.site-footer .newsletter-input{ width: 100% !important; }
      footer.site-footer .newsletter-btn{ width: 100% !important; }
      footer.site-footer .footer-bottom{ flex-direction: column !important; gap: .5rem !important; text-align: center !important; justify-content: center !important; }
      footer.site-footer .footer-bottom-links{ justify-content: center !important; }
      footer.site-footer .footer-socials{ justify-content: center !important; }
    }
  </style>
  <script>
    // DEBUG: Log variation data
    console.log('=== VARIATION DEBUG ===');
    console.log('Image variations count:', document.querySelectorAll('.image-variation-item').length);
    console.log('Dropdown selects count:', document.querySelectorAll('.variation-select').length);
    console.log('Dropdown options count:', document.querySelectorAll('.variation-select option[value]').length);
    
    (function(){
      var c = document.getElementById('descContent');
      var b = document.getElementById('descToggle');
      if(!c || !b) return;
      function needs(){ return c.scrollHeight > c.clientHeight + 4; }
      function sync(){ b.textContent = c.classList.contains('expanded') ? 'Read less' : 'Read more'; if(!needs()){ b.style.display='none'; } }
      b.addEventListener('click', function(){ c.classList.toggle('expanded'); sync(); });
      window.addEventListener('load', sync);
    })();
    // Sidebar wiring (match Home interactions)
    (function(){
      var overlay = document.getElementById('overlay');
      var left = document.getElementById('leftSidebar');
      var closeLeft = document.getElementById('closeLeft');
      function openLeft(){ left.classList.add('active'); overlay.classList.add('active'); }
      function closeAll(){ left.classList.remove('active'); overlay.classList.remove('active'); }
      // Hook menu button in header
      var menuBtn = document.querySelector('.menu-btn');
      if(menuBtn){ menuBtn.addEventListener('click', function(){ openLeft(); }); }
      if(closeLeft){ closeLeft.addEventListener('click', closeAll); }
      if(overlay){ overlay.addEventListener('click', closeAll); }
      document.addEventListener('keydown', function(e){ if(e.key==='Escape') closeAll(); });
    })();
    
    // Cart Sidebar Functions
    function toggleSidebar(side) {
      const sidebar = document.getElementById(side + 'Sidebar');
      const overlay = document.getElementById('overlay');
      closeAllSidebars();
      sidebar.classList.toggle('active');
      if (sidebar.classList.contains('active')) {
        overlay.classList.add('active');
      }
    }
    
    function closeAllSidebars() {
      document.getElementById('leftSidebar')?.classList.remove('active');
      document.getElementById('overlay')?.classList.remove('active');
    }

    // Modern Mini Cart Functions
    function openMiniCart() {
      const cart = document.getElementById('miniCart');
      const overlay = document.getElementById('miniCartOverlay');
      cart.classList.add('active');
      overlay.classList.add('active');
      document.body.style.overflow = 'hidden';
    }

    function closeMiniCart() {
      const cart = document.getElementById('miniCart');
      const overlay = document.getElementById('miniCartOverlay');
      cart.classList.remove('active');
      overlay.classList.remove('active');
      document.body.style.overflow = 'auto';
    }

    async function updateCartQty(cartKey, newQty) {
      if (newQty < 1) {
        removeCartItem(cartKey);
        return;
      }
      try {
        const res = await fetch(`/update-cart?product_id=${encodeURIComponent(cartKey)}&quantity=${newQty}&action=update&ajax=1`, {
          headers: { 'X-Requested-With': 'XMLHttpRequest' }
        });
        if (!res.ok) throw new Error('Failed to update');
        sessionStorage.setItem('keepMiniCartOpen', '1');
        location.reload();
      } catch (e) {
        console.error('Error updating quantity:', e);
        showCustomAlert('Failed to update cart');
      }
    }

    // Pure CSS alert function - now matches addtocart.html modal style exactly
    function showCustomAlert(message) {
      const overlay = document.createElement('div');
      overlay.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;z-index:10000';
      const backdrop = document.createElement('div');
      backdrop.style.cssText = 'position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);backdrop-filter:blur(5px)';
      const box = document.createElement('div');
      box.style.cssText = 'position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:linear-gradient(135deg,#1a1d24 0%,#0f1115 100%);border:1px solid #2a2f3a;border-radius:15px;box-shadow:0 15px 30px rgba(0,0,0,0.6);max-width:380px;width:90%';
      const header = document.createElement('div');
      header.style.cssText = 'padding:1.5rem 1.5rem 1rem;border-bottom:1px solid #2a2f3a;display:flex;justify-content:space-between;align-items:center';
      const title = document.createElement('h5');
      title.innerHTML = '<i class="fas fa-exclamation-triangle" style="color:#f59e0b;margin-right:0.5rem"></i>Selection Required';
      title.style.cssText = 'margin:0;color:#e5e7eb;font-weight:600;font-size:1rem';
      const closeBtn = document.createElement('button');
      closeBtn.innerHTML = '&times;';
      closeBtn.style.cssText = 'background:none;border:none;color:rgba(255,255,255,0.8);font-size:1.5rem;cursor:pointer;padding:0;line-height:1';
      closeBtn.onclick = () => document.body.removeChild(overlay);
      const body = document.createElement('div');
      body.style.cssText = 'padding:1.5rem;color:#e5e7eb;text-align:center';
      const msg = document.createElement('p');
      msg.textContent = message;
      msg.style.cssText = 'margin:0;line-height:1.6';
      const footer = document.createElement('div');
      footer.style.cssText = 'padding:1rem 1.5rem 1.5rem;display:flex;gap:0.75rem;justify-content:center';
      const okBtn = document.createElement('button');
      okBtn.innerHTML = '<i class="fas fa-check"></i> Got it';
      okBtn.style.cssText = 'background:rgba(229,231,235,0.9);color:#1a1d24;font-weight:600;border:1px solid rgba(229,231,235,0.3);border-radius:10px;padding:0.75rem 1.5rem;cursor:pointer;transition:all 0.2s ease';
      okBtn.onmouseover = () => okBtn.style.background = 'rgba(229,231,235,1)';
      okBtn.onmouseout = () => okBtn.style.background = 'rgba(229,231,235,0.9)';
      okBtn.onclick = () => document.body.removeChild(overlay);
      header.appendChild(title);
      header.appendChild(closeBtn);
      body.appendChild(msg);
      footer.appendChild(okBtn);
      box.appendChild(header);
      box.appendChild(body);
      box.appendChild(footer);
      overlay.appendChild(backdrop);
      overlay.appendChild(box);
      document.body.appendChild(overlay);
      backdrop.onclick = () => document.body.removeChild(overlay);
    }
    
    
    // Special modal for no variation options available - now matches addtocart.html modal style exactly
    function showNoVariationOptionsModal() {
      // Get current selected image variation name for context
      const selectedImageItem = document.querySelector('.image-variation-item.selected');
      const variationName = selectedImageItem ? 
        (selectedImageItem.querySelector('.variation-name')?.textContent || 'this variation') : 
        'this variation';
      
      const overlay = document.createElement('div');
      overlay.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;z-index:10000';
      const backdrop = document.createElement('div');
      backdrop.style.cssText = 'position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);backdrop-filter:blur(5px)';
      const box = document.createElement('div');
      box.style.cssText = 'position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:linear-gradient(135deg,#1a1d24 0%,#0f1115 100%);border:1px solid #2a2f3a;border-radius:15px;box-shadow:0 15px 30px rgba(0,0,0,0.6);max-width:420px;width:90%';
      const header = document.createElement('div');
      header.style.cssText = 'padding:1.5rem 1.5rem 1rem;border-bottom:1px solid #2a2f3a;display:flex;justify-content:space-between;align-items:center';
      const title = document.createElement('h5');
      title.innerHTML = '<i class="fas fa-info-circle" style="color:#f59e0b;margin-right:0.5rem"></i>Size Information';
      title.style.cssText = 'margin:0;color:#e5e7eb;font-weight:600;font-size:1rem';
      const closeBtn = document.createElement('button');
      closeBtn.innerHTML = '&times;';
      closeBtn.style.cssText = 'background:none;border:none;color:rgba(255,255,255,0.8);font-size:1.5rem;cursor:pointer;padding:0;line-height:1';
      closeBtn.onclick = () => document.body.removeChild(overlay);
      const body = document.createElement('div');
      body.style.cssText = 'padding:1.5rem;color:#e5e7eb;text-align:center';
      const msg = document.createElement('p');
      msg.innerHTML = `This <strong>${variationName}</strong> is available in <strong>one standard size only</strong>.<br><br>` +
        `Other colors may have multiple size options. You can add this item to cart as-is, or ` +
        `<strong>select a different color</strong> to see size options.`;
      msg.style.cssText = 'margin:0;line-height:1.6';
      const footer = document.createElement('div');
      footer.style.cssText = 'padding:1rem 1.5rem 1.5rem;display:flex;gap:0.75rem;justify-content:center';
      const cancelBtn = document.createElement('button');
      cancelBtn.innerHTML = '<i class="fas fa-times"></i> Cancel';
      cancelBtn.style.cssText = 'background:rgba(75,85,99,0.9);color:#e5e7eb;font-weight:600;border:1px solid rgba(75,85,99,0.5);border-radius:10px;padding:0.75rem 1.5rem;cursor:pointer;transition:all 0.2s ease';
      cancelBtn.onmouseover = () => cancelBtn.style.background = 'rgba(75,85,99,1)';
      cancelBtn.onmouseout = () => cancelBtn.style.background = 'rgba(75,85,99,0.9)';
      cancelBtn.onclick = () => document.body.removeChild(overlay);
      const addBtn = document.createElement('button');
      addBtn.innerHTML = '<i class="fas fa-shopping-cart"></i> Add to Cart Anyway';
      addBtn.style.cssText = 'background:rgba(229,231,235,0.9);color:#1a1d24;font-weight:600;border:1px solid rgba(229,231,235,0.3);border-radius:10px;padding:0.75rem 1.5rem;cursor:pointer;transition:all 0.2s ease';
      addBtn.onmouseover = () => addBtn.style.background = 'rgba(229,231,235,1)';
      addBtn.onmouseout = () => addBtn.style.background = 'rgba(229,231,235,0.9)';
      addBtn.onclick = () => {
        document.body.removeChild(overlay);
        proceedWithAddToCart();
      };
      header.appendChild(title);
      header.appendChild(closeBtn);
      body.appendChild(msg);
      footer.appendChild(cancelBtn);
      footer.appendChild(addBtn);
      box.appendChild(header);
      box.appendChild(body);
      box.appendChild(footer);
      overlay.appendChild(backdrop);
      overlay.appendChild(box);
      document.body.appendChild(overlay);
      backdrop.onclick = () => document.body.removeChild(overlay);
    }
    
    // Function to proceed with add to cart without variation checks
    function proceedWithAddToCart() {
      const productId = '{{ product.id }}';
      const imgVarId = document.getElementById('selectedImageVariations')?.value;
      const currentImage = document.querySelector('.selected-image')?.src;
      
      // Build redirect URL
      const currentPath = window.location.pathname + window.location.search;
      const redirectUrl = currentPath;
      const params = new URLSearchParams({ product_id: String(productId), redirect: redirectUrl });
      if (imgVarId) params.set('img_var_id', imgVarId);
      if (currentImage) params.set('variation_image', currentImage);
      
      window.location.href = '/add-to-cart?' + params.toString();
    }

    function removeCartItem(cartKey) {
      // Simple version - just reload page after removal
      console.log('Removing cart item with key:', cartKey);
      
      if (confirm('Are you sure you want to remove this item from your cart?')) {
        try {
          // Use XMLHttpRequest instead of fetch to avoid context issues
          const xhr = new XMLHttpRequest();
          const url = `/update-cart?product_id=${encodeURIComponent(cartKey)}&action=remove&ajax=1`;
          
          xhr.open('GET', url, true);
          xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
          
          xhr.onreadystatechange = function() {
            if (xhr.readyState === 4) {
              console.log('Response status:', xhr.status);
              
              if (xhr.status === 200) {
                try {
                  const data = JSON.parse(xhr.responseText);
                  console.log('Response data:', data);
                  
                  if (data.success) {
                    // Just reload the page
                    window.location.reload();
                  } else {
                    console.error('Backend error:', data.error);
                    alert('Failed to remove item: ' + (data.error || 'Unknown error'));
                  }
                } catch (parseError) {
                  console.error('JSON parse error:', parseError);
                  alert('Error parsing server response');
                }
              } else {
                console.error('HTTP error:', xhr.status);
                alert('Failed to remove item (HTTP ' + xhr.status + ')');
              }
            }
          };
          
          xhr.onerror = function() {
            console.error('Network error');
            alert('Network error removing item');
          };
          
          xhr.send();
          
        } catch (e) {
          console.error('Error:', e);
          alert('Error removing item: ' + e.message);
        }
      }
      return;
      
      // Original complex version below (commented out)
      /*
      const overlay = document.createElement('div');
      overlay.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;z-index:10000';
      const backdrop = document.createElement('div');
      backdrop.style.cssText = 'position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);backdrop-filter:blur(5px)';
      const box = document.createElement('div');
      box.style.cssText = 'position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:linear-gradient(135deg,#1a1d24 0%,#0f1115 100%);border:1px solid #2a2f3a;border-radius:15px;box-shadow:0 15px 30px rgba(0,0,0,0.6);max-width:380px;width:90%';
      const header = document.createElement('div');
      header.style.cssText = 'padding:1.5rem 1.5rem 1rem;border-bottom:1px solid #2a2f3a;display:flex;justify-content:space-between;align-items:center';
      const title = document.createElement('h5');
      title.innerHTML = '<i class="fas fa-question-circle" style="color:#f59e0b;margin-right:0.5rem"></i>Remove Item?';
      title.style.cssText = 'margin:0;color:#e5e7eb;font-weight:600;font-size:1rem';
      const closeBtn = document.createElement('button');
      closeBtn.innerHTML = '&times;';
      closeBtn.style.cssText = 'background:none;border:none;color:rgba(255,255,255,0.8);font-size:1.5rem;cursor:pointer;padding:0;line-height:1';
      closeBtn.onclick = () => document.body.removeChild(overlay);
      const body = document.createElement('div');
      body.style.cssText = 'padding:1.5rem;color:#e5e7eb;text-align:center';
      const msg = document.createElement('p');
      msg.textContent = 'Are you sure you want to remove this item from your cart?';
      msg.style.cssText = 'margin:0;line-height:1.6';
      const footer = document.createElement('div');
      footer.style.cssText = 'padding:1rem 1.5rem 1.5rem;display:flex;gap:0.75rem;justify-content:center';
      const cancelBtn = document.createElement('button');
      cancelBtn.innerHTML = '<i class="fas fa-times"></i> Cancel';
      cancelBtn.style.cssText = 'background:rgba(75,85,99,0.9);color:#e5e7eb;font-weight:600;border:1px solid rgba(75,85,99,0.5);border-radius:10px;padding:0.75rem 1.5rem;cursor:pointer;transition:all 0.2s ease';
      cancelBtn.onmouseover = () => cancelBtn.style.background = 'rgba(75,85,99,1)';
      cancelBtn.onmouseout = () => cancelBtn.style.background = 'rgba(75,85,99,0.9)';
      cancelBtn.onclick = () => document.body.removeChild(overlay);
      const removeBtn = document.createElement('button');
      removeBtn.innerHTML = '<i class="fas fa-trash"></i> Remove';
      removeBtn.style.cssText = 'background:rgba(229,231,235,0.9);color:#1a1d24;font-weight:600;border:1px solid rgba(229,231,235,0.3);border-radius:10px;padding:0.75rem 1.5rem;cursor:pointer;transition:all 0.2s ease';
      removeBtn.onmouseover = () => removeBtn.style.background = 'rgba(229,231,235,1)';
      removeBtn.onmouseout = () => removeBtn.style.background = 'rgba(229,231,235,0.9)';
      removeBtn.onclick = async () => {
        document.body.removeChild(overlay);
        console.log('Attempting to remove item:', productId);
        
        try {
          const res = await fetch(`/update-cart?product_id=${productId}&action=remove&ajax=1`, {
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
          });
          
          console.log('Response status:', res.status);
          
          if (!res.ok) {
            throw new Error(`HTTP error! status: ${res.status}`);
          }
          
          const cartData = await res.json();
          console.log('Cart data received:', cartData);
          
          if (cartData.success) {
            // Remove item from mini cart UI
            const cartItem = document.querySelector(`[data-cart-id="${productId}"]`);
            console.log('Found cart item element:', cartItem);
            
            if (cartItem) {
              cartItem.remove();
              console.log('Item removed from DOM');
            } else {
              console.log('Cart item element not found with selector:', `[data-cart-id="${productId}"]`);
            }
            
            // Update cart count badge
            const cartCount = document.querySelector('.cart-count');
            if (cartCount) {
              cartCount.textContent = cartData.cart_count || 0;
              console.log('Updated cart count to:', cartData.cart_count);
            }
            
            // Update mini cart total
            const cartTotal = document.querySelector('.mini-cart-total');
            if (cartTotal && cartData.cart_total !== undefined) {
              cartTotal.textContent = `RWF ${cartData.cart_total.toLocaleString()}`;
              console.log('Updated cart total to:', cartData.cart_total);
            }
            
            // Show success message
            showCustomAlert('Item removed from cart');
          } else {
            console.error('Backend returned success=false:', cartData);
            showCustomAlert('Failed to remove item: ' + (cartData.error || 'Unknown error'));
          }
        } catch (e) {
          console.error('Error removing item:', e);
          showCustomAlert('Failed to remove item: ' + e.message);
        }
      };
      header.appendChild(title);
      header.appendChild(closeBtn);
      body.appendChild(msg);
      footer.appendChild(cancelBtn);
      footer.appendChild(removeBtn);
      box.appendChild(header);
      box.appendChild(body);
      box.appendChild(footer);
      overlay.appendChild(backdrop);
      overlay.appendChild(box);
      document.body.appendChild(overlay);
      backdrop.onclick = () => document.body.removeChild(overlay);
    }
    */
    }

    // Close mini cart with Escape key
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        closeMiniCart();
        closeImageZoom();
      }
    });
    
    // Image Zoom Functions
    function openImageZoom() {
      const mainImage = document.getElementById('mainProductImage');
      const zoomOverlay = document.getElementById('zoomOverlay');
      const zoomedImage = document.getElementById('zoomedImage');
      
      if (!mainImage || !zoomOverlay || !zoomedImage) return;
      
      // Set zoomed image source and alt text
      zoomedImage.src = mainImage.src;
      zoomedImage.alt = mainImage.alt;
      
      // Show overlay
      zoomOverlay.classList.add('active');
      document.body.style.overflow = 'hidden';
      
      // Add fade-in animation
      zoomOverlay.style.opacity = '0';
      setTimeout(() => {
        zoomOverlay.style.transition = 'opacity 0.3s ease';
        zoomOverlay.style.opacity = '1';
      }, 10);
    }
    
    function closeImageZoom() {
      const zoomOverlay = document.getElementById('zoomOverlay');
      
      if (!zoomOverlay) return;
      
      // Add fade-out animation
      zoomOverlay.style.opacity = '0';
      
      setTimeout(() => {
        zoomOverlay.classList.remove('active');
        zoomOverlay.style.transition = '';
        zoomOverlay.style.opacity = '';
        document.body.style.overflow = 'auto';
      }, 300);
    }
    
    // Update zoom when image variation changes
    function updateZoomImage(newImageSrc) {
      const zoomedImage = document.getElementById('zoomedImage');
      if (zoomedImage) {
        zoomedImage.src = newImageSrc;
      }
    }
    
    // Image variation selection
    const originalImage = '{{ product.image }}';
    
    function selectImageVariation(imgVarId, imgUrl, name, description, imgStock, element) {
      // Check if this image variation is sold out
      if(imgStock <= 0){
        showCustomAlert('This variation is sold out. Please choose another.');
        return;
      }
      
      // Update main product image with minimal side slide
      const mainImg = document.getElementById('mainProductImage');
      
      // Clear any existing animation classes
      mainImg.classList.remove('slide-out', 'slide-in');
      
      // Add slide-out animation
      mainImg.classList.add('slide-out');
      
      // Change image after slide-out starts
      setTimeout(() => {
        mainImg.src = imgUrl;
        
        // Update zoom image when main image changes
        updateZoomImage(imgUrl);
        
        // Apply slide-in animation after image loads
        mainImg.onload = function() {
          mainImg.classList.remove('slide-out');
          mainImg.classList.add('slide-in');
          
          // Clean up animation class
          setTimeout(() => {
            mainImg.classList.remove('slide-in');
          }, 350);
        };
        
        // Fallback for immediate load
        setTimeout(() => {
          if (mainImg.classList.contains('slide-out')) {
            mainImg.classList.remove('slide-out');
            mainImg.classList.add('slide-in');
            setTimeout(() => mainImg.classList.remove('slide-in'), 350);
          }
        }, 50);
      }, 120);
      
      // Reset all thumbnails to unselected state
      const allItems = document.querySelectorAll('.image-variation-item');
      allItems.forEach(item => {
        const frame = item.querySelector('div');
        if (frame) {
          frame.style.opacity = '.9';
          frame.style.border = 'none';
          frame.style.borderColor = 'transparent';
          frame.style.boxShadow = 'none';
          frame.style.outline = 'none';
        }
      });
      
      // Highlight selected thumbnail with forest green border
      const selectedFrame = element.querySelector('div');
      if (selectedFrame) {
        selectedFrame.style.opacity = '1';
        selectedFrame.style.border = '3px solid #2e4d2c';
        selectedFrame.style.borderColor = '#2e4d2c';
        selectedFrame.style.boxShadow = 'none';
        selectedFrame.style.outline = 'none';
      }
      
      // Store selected image variation id
      document.getElementById('selectedImageVariations').value = String(imgVarId || '');
      
      // Show NAME as a small subtitle under the title
      var sub = document.getElementById('variantSubtitle');
      if (sub) {
        sub.textContent = name;
        sub.style.display = 'block';
      }
      
      // Show ALL dropdowns that are either:
      // 1. Global (no img_var_id)
      // 2. Linked to current image variation
      // 3. Have stock > 0
      const boxes = document.querySelectorAll('.variation-box');
      let hasAnyAvailable = false;

      boxes.forEach(function(box) {
        const linkId = box.getAttribute('data-img-var-id') || '';
        const stock = parseInt(box.getAttribute('data-stock') || '0', 10);
        const isGlobal = linkId === '' || linkId === 'null' || linkId === 'undefined';
        const matchesImage = linkId === String(imgVarId);

        // If an image variation is selected, ONLY show options linked to that specific image
        // Do NOT show global options when a specific image is selected
        if (imgVarId && imgVarId !== '' && imgVarId !== 'null') {
          // Strict filtering: only show options specifically linked to this image variation
          if (matchesImage && stock > 0) {
            box.style.display = '';
            box.disabled = false;
            hasAnyAvailable = true;
          } else {
            box.style.display = 'none';
            box.disabled = true;
          }
        } else {
          // No image variation selected: show global options and any with stock
          if ((isGlobal || matchesImage) && stock > 0) {
            box.style.display = '';
            box.disabled = false;
            hasAnyAvailable = true;
          } else {
            box.style.display = 'none';
            box.disabled = true;
          }
        }
      });

      // If no dropdowns are available, allow add-to-cart anyway (validation will handle it)
      
      // Clear any incompatible dropdown selections
      if (imgVarId && imgVarId !== '' && imgVarId !== 'null') {
        document.querySelectorAll('.variation-box.active').forEach(function(activeBox) {
          const linkedImgVarId = activeBox.getAttribute('data-img-var-id') || '';
          // If this dropdown is linked to a different image variation, deselect it
          if (linkedImgVarId && linkedImgVarId !== '' && linkedImgVarId !== 'null' && linkedImgVarId !== String(imgVarId)) {
            activeBox.classList.remove('active');
          }
        });
      }
      
      // Refresh hidden input for dropdowns
      updateSelectedDropdownVariations();
      
      // Reset quantity to 1 when variation changes
      const qtyEl = document.getElementById('productQuantity');
      if (qtyEl) qtyEl.textContent = '1';
    }
    
    // Variation box click tracking is handled by onclick="selectVariationBox(this)" in the HTML
    
    // Initialize dropdown variations on page load
    function initDropdownState(){
      const hasImageVars = document.querySelectorAll('.image-variation-item').length > 0;
      const hasDropdownVars = document.querySelectorAll('.variation-boxes').length > 0;
      
      // Check image variations based on their own stock
      if(hasImageVars){
        // First check if ANY dropdown is linked to images
        let hasLinkedDropdowns = false;
        if(hasDropdownVars){
          document.querySelectorAll('.variation-boxes button').forEach(function(opt){
            if(!opt.value) return;
            const linkId = opt.getAttribute('data-img-var-id');
            if(linkId && linkId !== ''){
              hasLinkedDropdowns = true;
            }
          });
        }
        
        // Always show stock badges on image variations
        document.querySelectorAll('.image-variation-item').forEach(function(imgItem){
          const imgStock = parseInt(imgItem.getAttribute('data-stock') || '0', 10);
          const stockBadge = imgItem.querySelector('.stock-badge');
          const soldOutBadge = imgItem.querySelector('.sold-out-badge');
          
          if(imgStock <= 0){
            // Show sold-out overlay
            if(soldOutBadge) soldOutBadge.style.display = 'flex';
            imgItem.style.opacity = '0.5';
            imgItem.style.cursor = 'not-allowed';
            imgItem.style.pointerEvents = 'none';
          } else {
            // Show stock count badge
            if(stockBadge){
              stockBadge.textContent = imgStock;
              stockBadge.style.display = 'block';
            }
            // Ensure clickable
            imgItem.style.pointerEvents = 'auto';
            imgItem.style.cursor = 'pointer';
          }
        });
        
        // Handle variation boxes based on configuration
        if(hasDropdownVars && !hasLinkedDropdowns){
          // If boxes are NOT linked to images, enable them all and hide stock=0
          document.querySelectorAll('.variation-box').forEach(function(box){
            const stock = parseInt(box.getAttribute('data-stock') || '0', 10);
            if(stock <= 0){
              box.style.display = 'none';
              box.disabled = true;
            }
          });
        } else if(hasDropdownVars && hasLinkedDropdowns){
          // If boxes ARE linked to images, hide them until an image is selected
          document.querySelectorAll('.variation-box').forEach(function(box){ 
            box.style.display = 'none';
            box.disabled = true; 
          });
        }
      }
      
      // If only variation boxes, hide boxes with no stock
      if(!hasImageVars && hasDropdownVars){
        document.querySelectorAll('.variation-box').forEach(function(box){
          const stock = parseInt(box.getAttribute('data-stock') || '0', 10);
          if(stock <= 0){
            box.style.display = 'none';
            box.disabled = true;
          }
        });
      }
    }
    
    // The initialization is now handled in the main IIFE below to ensure proper order
    
    function updateSelectedDropdownVariations() {
      const selections = [];
      document.querySelectorAll('.variation-box.active').forEach(button => {
        // Store the variation ID
        selections.push(button.getAttribute('data-variation-id'));
      });
      document.getElementById('selectedDropdownVariations').value = selections.join(',');
    }
    
    function selectVariationBox(button) {
      // Remove active from all boxes in the same group
      const groupName = button.getAttribute('data-variation-name');
      document.querySelectorAll(`.variation-box[data-variation-name="${groupName}"]`).forEach(box => {
        box.classList.remove('active');
      });
      // Add active to clicked box
      button.classList.add('active');
      updateSelectedDropdownVariations();
      
      // Reset quantity to 1 when variation changes
      const qtyEl = document.getElementById('productQuantity');
      if (qtyEl) qtyEl.textContent = '1';
    }
    
    // Quantity change function with validation
    function changeQuantity(delta) {
      const qtyEl = document.getElementById('productQuantity');
      const warningEl = document.getElementById('qtyWarning');
      if (!qtyEl) return;
      
      // Get max stock
      let maxStock = 99;
      
      // Check if variations exist
      const hasImageVars = document.querySelectorAll('.image-variation-item').length > 0;
      const hasDropdownVars = document.querySelectorAll('.variation-boxes').length > 0;
      
      if (hasImageVars || hasDropdownVars) {
        // Check if variation is selected
        const dropdownVarId = (document.getElementById('selectedDropdownVariations')?.value || '').split(',').filter(Boolean)[0];
        const imgVarId = document.getElementById('selectedImageVariations')?.value?.trim();
        
        if (hasDropdownVars && !dropdownVarId) {
          warningEl.textContent = 'Please select a size first';
          warningEl.style.display = 'block';
          setTimeout(() => warningEl.style.display = 'none', 3000);
          return;
        }
        
        if (hasImageVars && !imgVarId) {
          warningEl.textContent = 'Please select a color first';
          warningEl.style.display = 'block';
          setTimeout(() => warningEl.style.display = 'none', 3000);
          return;
        }
        
        // Get stock from selected variation
        if (dropdownVarId) {
          const selectedBox = document.querySelector(`.variation-box[data-variation-id="${dropdownVarId}"]`);
          if (selectedBox) {
            maxStock = parseInt(selectedBox.getAttribute('data-stock') || '99', 10);
          }
        } else if (hasImageVars && !hasDropdownVars && imgVarId) {
          // If only image variations (no dropdown), use image variation stock
          const selectedImg = document.querySelector(`.image-variation-item[data-img-var-id="${imgVarId}"]`);
          if (selectedImg) {
            maxStock = parseInt(selectedImg.getAttribute('data-stock') || '99', 10);
          }
        }
      } else {
        // No variations, use product stock
        const stockEl = document.querySelector('[data-product-stock]');
        if (stockEl) {
          maxStock = parseInt(stockEl.getAttribute('data-product-stock') || '99', 10);
        }
      }
      
      // Update quantity
      let current = parseInt(qtyEl.textContent || '1', 10);
      current += delta;
      
      if (current < 1) {
        current = 1;
      }
      
      if (current > maxStock) {
        warningEl.textContent = `Only ${maxStock} available in stock`;
        warningEl.style.display = 'block';
        setTimeout(() => warningEl.style.display = 'none', 3000);
        current = maxStock;
      }
      
      qtyEl.textContent = current;
      warningEl.style.display = 'none';
    }
    
    // Toast notification function
    function showToast(message, type = 'success') {
      let container = document.querySelector('.toast-container');
      if (!container) {
        container = document.createElement('div');
        container.className = 'toast-container';
        container.style.cssText = `
          position: fixed;
          bottom: 20px;
          right: 20px;
          z-index: 9999;
          display: flex;
          flex-direction: column;
          gap: 10px;
        `;
        document.body.appendChild(container);
      }

      const toast = document.createElement('div');
      const bgColor = type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#3b82f6';
      toast.style.cssText = `
        background-color: ${bgColor};
        color: white;
        padding: 12px 20px;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 500;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        animation: slideIn 0.3s ease-out;
      `;
      toast.textContent = message;
      container.appendChild(toast);

      setTimeout(() => {
        toast.style.animation = 'slideOut 0.3s ease-out';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    // Share functions
    function shareOnWhatsApp(productName, productUrl) {
      const text = ` Check out this amazing product!\n\n${productName}\n\n${productUrl}\n\nShare with your friends!`;
      const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(text)}`;
      window.open(whatsappUrl, '_blank');
    }
    
    function shareOnFacebook(productUrl) {
      const facebookUrl = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(productUrl)}&quote=Check%20out%20this%20amazing%20product%20from%20CiTiPlug!`;
      window.open(facebookUrl, '_blank', 'width=600,height=400');
    }
    
    function shareOnInstagram(productName, productUrl) {
      // Copy the link and show instructions
      const shareText = `${productName}\n\n${productUrl}\n\nShare with your followers!`;
      navigator.clipboard.writeText(shareText).then(() => {
        // Open Instagram after a short delay
        setTimeout(() => {
          window.open('https://www.instagram.com/', '_blank');
        }, 500);
      }).catch(err => {
        console.error('Failed to copy:', err);
        window.open('https://www.instagram.com/', '_blank');
      });
    }
    
    function copyProductLink(productUrl) {
      navigator.clipboard.writeText(productUrl).then(() => {
        // Show only the copy icon without flash message
      }).catch(err => {
        console.error('Failed to copy:', err);
      });
    }
    
    async function addToCartWithVariations(productId) {
      const imgVarId = document.getElementById('selectedImageVariations').value.trim();
      const dropdownVarIds = (document.getElementById('selectedDropdownVariations').value || '')
        .split(',')
        .map(id => id.trim())
        .filter(Boolean);
      const dropdownVarId = dropdownVarIds[0] || '';

      const hasImageVars = document.querySelectorAll('.image-variation-item').length > 0;
      const hasDropdownVars = document.querySelectorAll('.variation-boxes').length > 0;

      // Get currently visible dropdown options (after filtering)
      const visibleDropdowns = document.querySelectorAll('.variation-boxes button:not([disabled]):not([style*="display: none"])');
      const hasVisibleDropdowns = visibleDropdowns.length > 0;

      // Get current image
      const mainImageEl = document.getElementById('mainProductImage');
      let currentImage = mainImageEl ? mainImageEl.src : '';
      // Extract pathname from full URL if needed
      if (currentImage && currentImage.includes('://')) {
        try { 
          const url = new URL(currentImage); 
          currentImage = url.pathname;
          // Ensure it starts with /static/ for consistency
          if (!currentImage.startsWith('/static/')) {
            currentImage = '/static' + (currentImage.startsWith('/') ? currentImage : '/' + currentImage);
          }
        } catch (_) {}
      }

      // === FINAL RULE: Only require selection if options are ACTUALLY visible ===
      if (hasImageVars && !imgVarId) {
        showCustomAlert('Please select a color.');
        return;
      }

      if (hasDropdownVars && hasVisibleDropdowns && !dropdownVarId) {
        showCustomAlert('Please select a size.');
        return;
      }

      // === CROSS-VALIDATION: Check if selected dropdown is compatible with selected image ===
      if (imgVarId && dropdownVarId) {
        const selectedDropdownBox = document.querySelector(`.variation-box[data-variation-id="${dropdownVarId}"]`);
        if (selectedDropdownBox) {
          const linkedImgVarId = selectedDropdownBox.getAttribute('data-img-var-id') || '';
          // If the dropdown is linked to a specific image, it must match the selected image
          if (linkedImgVarId && linkedImgVarId !== '' && linkedImgVarId !== 'null' && linkedImgVarId !== String(imgVarId)) {
            showCustomAlert('This size is not available for the selected color. Please choose a different size or color.');
            return;
          }
        }
      }

      // === ALLOW ADD TO CART IF NO OPTIONS ARE VISIBLE (but product has stock) ===
      if (hasDropdownVars && !hasVisibleDropdowns && !dropdownVarId) {
        // This means: dropdowns exist, but none are in stock or visible  allow add anyway
        // Or: dropdowns are global, but filtered out  treat as "no selection needed"
      }

      // Final stock check on selected dropdown
      if (dropdownVarId) {
        const selectedBox = document.querySelector(`.variation-box[data-variation-id="${dropdownVarId}"]`);
        if (selectedBox) {
          const stock = parseInt(selectedBox.getAttribute('data-stock') || '0', 10);
          if (stock <= 0) {
            showCustomAlert('Selected size is out of stock.');
            return;
          }
        }
      }

      // === BUILD URL AND REDIRECT ===
      const currentPath = window.location.pathname + window.location.search;
      const redirectUrl = currentPath;
      const quantity = parseInt(document.getElementById('productQuantity')?.textContent || '1', 10);
      const params = new URLSearchParams({
        product_id: String(productId),
        quantity: String(quantity),
        redirect: redirectUrl
      });
      if (imgVarId) params.set('img_var_id', imgVarId);
      if (dropdownVarId) params.set('dropdown_var_id', dropdownVarId);
      if (currentImage) params.set('variation_image', currentImage);

      console.log('ADD TO CART URL:', '/add-to-cart?' + params.toString());
      console.log('currentImage:', currentImage);
      window.location.href = '/add-to-cart?' + params.toString();
    }
    
    async function addToCartAndShowSidebar(productId) {
      // Legacy function - redirect to new function
      addToCartWithVariations(productId);
    }
    
    function buyNow(productId) {
      // Validate selections first (same as add to cart)
      const hasImageVars = document.querySelectorAll('.image-variation-item').length > 0;
      const hasDropdownVars = document.querySelectorAll('.variation-boxes').length > 0;
      
      // Get current selections
      const imgVarId = document.getElementById('selectedImageVariations')?.value?.trim();
      const dropdownVarId = document.getElementById('selectedDropdownVariations')?.value?.trim();
      
      // Get currently visible dropdown options (after filtering)
      const visibleDropdowns = document.querySelectorAll('.variation-boxes button:not([disabled]):not([style*="display: none"])');
      const hasVisibleDropdowns = visibleDropdowns.length > 0;
      
      // === VALIDATION RULES ===
      if (hasImageVars && !imgVarId) {
        showCustomAlert('Please select a color.');
        return;
      }

      if (hasDropdownVars && hasVisibleDropdowns && !dropdownVarId) {
        showCustomAlert('Please select a size.');
        return;
      }

      // === CROSS-VALIDATION: Check if selected dropdown is compatible with selected image ===
      if (imgVarId && dropdownVarId) {
        const selectedDropdownBox = document.querySelector(`.variation-box[data-variation-id="${dropdownVarId}"]`);
        if (selectedDropdownBox) {
          const linkedImgVarId = selectedDropdownBox.getAttribute('data-img-var-id') || '';
          // If the dropdown is linked to a specific image, it must match the selected image
          if (linkedImgVarId && linkedImgVarId !== '' && linkedImgVarId !== 'null' && linkedImgVarId !== String(imgVarId)) {
            showCustomAlert('This size is not available for the selected color. Please choose a different size or color.');
            return;
          }
        }
      }
      
      // Get current image (same logic as addToCartWithVariations)
      const mainImageEl = document.getElementById('mainProductImage');
      let currentImage = mainImageEl ? mainImageEl.src : '';
      if (currentImage && currentImage.includes('://')) {
        try { 
          const url = new URL(currentImage); 
          currentImage = url.pathname;
          // Ensure it starts with /static/ for consistency
          if (!currentImage.startsWith('/static/')) {
            currentImage = '/static' + (currentImage.startsWith('/') ? currentImage : '/' + currentImage);
          }
        } catch (_) {}
      }
      
      // Build URL with all parameters
      const quantity = parseInt(document.getElementById('productQuantity')?.textContent || '1', 10);
      const params = new URLSearchParams({
        product_id: productId,
        quantity: quantity,
        buy_now: '1'  // Signal that this is a buy now request
      });
      
      // Add variations to params
      if (imgVarId) {
        params.append('img_var_id', imgVarId);
      }
      
      if (dropdownVarId) {
        params.append('dropdown_var_id', dropdownVarId);
      }
      
      if (currentImage) {
        params.append('variation_image', currentImage);
      }
      
      // Redirect directly to add-to-cart with buy_now parameter
      // Backend will add to cart and redirect to checkout
      console.log('Buy Now URL:', '/add-to-cart?' + params.toString());
      window.location.href = '/add-to-cart?' + params.toString();
    }
    
    async function refreshCartSidebar() {
      try {
        const res = await fetch('/api/cart');
        const data = await res.json();
        const container = document.getElementById('cartItemsContainer');
        const footer = document.getElementById('cartFooter');
        const totalEl = document.getElementById('cartTotal');
        
        if (!data.items || data.items.length === 0) {
          container.innerHTML = '<div class="empty-cart"><i class="fas fa-shopping-bag"></i><p>Your cart is empty</p></div>';
          footer.style.display = 'none';
          return;
        }
        
        let html = '<div class="cart-items-list">';
        let total = 0;
        data.items.forEach(item => {
          const subtotal = item.price * item.quantity;
          total += subtotal;
          // Format variations - display as "attr: value, attr2: value2"
          let variationsHtml = '';
          if (item.variations && item.variations.trim()) {
            // Format: "color:Brown, size:41" -> "Color: Brown, Size: 41"
            const formatted = item.variations
              .split(',')
              .map(part => {
                const [key, value] = part.split(':').map(s => s.trim());
                if (key && value) {
                  return `${key.charAt(0).toUpperCase() + key.slice(1)}: ${value}`;
                }
                return part.trim();
              })
              .join('  ');
            variationsHtml = `<div class="cart-item-variations" style="font-size: 0.72rem; color: var(--text-light); margin: 0.25rem 0 0.4rem 0; font-weight: 500; line-height: 1.4;">${formatted}</div>`;
          }
          html += `
            <div class="cart-item" style="cursor: pointer;" onclick="navigateToProduct(event, '${item.product_id}')">
              <a href="/product/${item.product_id}" class="cart-item-image" style="display: block; text-decoration: none;"><img src="${item.image}" alt="${item.name}" onerror="this.src='/static/images/placeholder.png'"></a>
              <div class="cart-item-details">
                <a href="/product/${item.product_id}" class="cart-item-name" style="color: inherit; text-decoration: none; display: block; cursor: pointer;">${item.name}</a>
                ${variationsHtml}
                <div class="cart-item-price">RWF ${item.price.toLocaleString()}</div>
                <div class="cart-item-quantity">Qty: ${item.quantity}</div>
                <div class="cart-item-controls">
                  <button onclick="removeFromCart('${item.id}')" class="remove-btn"><i class="fas fa-trash"></i> Remove</button>
                  <a href="/wishlist" class="wishlist-link-btn"><i class="fas fa-bookmark"></i> Wishlist</a>
                </div>
              </div>
            </div>
          `;
        });
        html += '</div>';
        container.innerHTML = html;
        totalEl.textContent = `RWF ${total.toLocaleString('en-US', {minimumFractionDigits: 1, maximumFractionDigits: 1})}`;
        footer.style.display = 'block';
      } catch (err) {
        console.error('Refresh cart error:', err);
      }
    }
    
    async function updateQuantity(productId, quantity) {
      try {
        const res = await fetch(`/update-cart?product_id=${productId}&quantity=${quantity}&action=update&ajax=1`, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
        if (!res.ok) throw new Error('Request failed');
        const data = await res.json();
        const badge = document.querySelector('.cart-badge');
        if (badge && typeof data.cart_count !== 'undefined') badge.textContent = data.cart_count;
        // Full page reload to show flash messages
        location.reload();
      } catch (e) { console.error(e); }
    }
    function stepQty(btn, delta, max){
      const wrap = btn.closest('.qty-control');
      const input = wrap?.querySelector('.quantity-input');
      const m = parseInt(max||'99',10);
      let v = parseInt(input?.value||'1',10) + delta; if (v<1) v=1; if (v>m) v=m;
      if (input) input.value = v;
      updateQuantity(btn.dataset.id, v);
    }
    function removeFromCart(productId) {
      window.location.href = `/update-cart?product_id=${productId}&action=remove&redirect_to=${encodeURIComponent(window.location.pathname + window.location.search)}`;
    }
    
    // Load cart on page load and auto-select first image variation
    (function() {
      refreshCartSidebar();
      
      // Initialize stock badges FIRST before auto-selecting
      initDropdownState();
      
      // Auto-select first in-stock image variation if available
      const imgItems = Array.from(document.querySelectorAll('.image-variation-item'));
      const firstInStock = imgItems.find(el => parseInt(el.getAttribute('data-stock') || '0', 10) > 0);
      if (firstInStock) {
        const imgVarId = firstInStock.getAttribute('data-img-var-id');
        const stock = parseInt(firstInStock.getAttribute('data-stock') || '0', 10);
        const imgUrl = firstInStock.querySelector('img')?.src;
        const name = firstInStock.getAttribute('data-name') || firstInStock.getAttribute('title') || '';
        const description = firstInStock.getAttribute('title') || '';
        if (imgVarId && stock > 0 && imgUrl) {
          selectImageVariation(imgVarId, imgUrl, name, description, stock, firstInStock);
        }
      }
      
      // Auto mini-cart popup removed - using flash messages instead
    })();
    // Wishlist via server POST for flash banners handled by inline form submits above
    (function(){
      var btn = document.getElementById('wishlistBtn');
      if(!btn) return;
      btn.addEventListener('click', function(){
        var inList = btn.getAttribute('data-in') === '1';
        var form = document.getElementById(inList ? 'wlRemove' : 'wlAdd');
        if(form) form.submit();
      });
    })();

    // Rating selector for reviews
    (function(){
      var wrap = document.getElementById('ratingInput');
      if(!wrap) return;
      var stars = wrap.querySelectorAll('.star');
      var input = document.getElementById('ratingValue');
      var text = document.getElementById('ratingText');
      var errorMsg = document.getElementById('ratingError');
      function paint(n){
        stars.forEach(function(s){
          var v = parseInt(s.getAttribute('data-val'));
          if(v <= n){ s.classList.add('active'); s.classList.remove('fa-regular'); s.classList.add('fa-solid'); }
          else { s.classList.remove('active'); s.classList.remove('fa-solid'); s.classList.add('fa-regular'); }
        });
        text.textContent = n ? (n + '/5') : '';
      }
      stars.forEach(function(s){
        s.addEventListener('click', function(){
          var val = parseInt(this.getAttribute('data-val'));
          input.value = val;
          paint(val);
          if(errorMsg) errorMsg.style.display = 'none';
        });
        s.addEventListener('mouseenter', function(){ paint(parseInt(this.getAttribute('data-val'))); });
      });
      wrap.addEventListener('mouseleave', function(){ paint(parseInt(input.value || '0')); });
      
      // Form validation
      var form = document.getElementById('reviewForm');
      if(form){
        form.addEventListener('submit', function(e){
          if(!input.value || input.value === '0'){
            e.preventDefault();
            if(errorMsg) errorMsg.style.display = 'block';
            wrap.scrollIntoView({ behavior: 'smooth', block: 'center' });
            stars[0].focus();
            
            // Re-enable form in case it got disabled
            form.classList.remove('form-loading');
            var submitBtn = form.querySelector('button[type="submit"]');
            if(submitBtn) {
              submitBtn.disabled = false;
              submitBtn.classList.remove('btn-loading');
            }
            
            return false;
          } else {
            // Hide error message if rating is selected
            if(errorMsg) errorMsg.style.display = 'none';
          }
        });
      }
    })();

    // Page loader + entrance animations
    (function(){
      var loader = document.getElementById('pageLoader');
      function hideLoader(){ if(loader) loader.classList.remove('active'); }
      window.addEventListener('pageshow', hideLoader);
      window.addEventListener('load', function(){
        hideLoader();
        // Reveal main product section
        var mainSection = document.querySelector('.product-layout.reveal');
        if(mainSection){ requestAnimationFrame(function(){ mainSection.classList.add('show'); }); }
        // Stagger related tiles
        var tiles = document.querySelectorAll('.related .product-card.reveal-scale');
        tiles.forEach(function(el, i){
          setTimeout(function(){ el.classList.add('show'); }, 60 + i*60);
        });
        // Make related links show loader immediately on click
        document.querySelectorAll('.related .product-card a').forEach(function(a){
          a.addEventListener('click', function(){ if(loader) loader.classList.add('active'); });
        });
      });
    })();

    // Toggle Read More for reviews/replies
    function toggleReview(id, link) {
      const container = document.getElementById(id);
      if (!container) return;
      const shortText = container.querySelector('.short-text');
      const fullText = container.querySelector('.full-text');
      if (!shortText || !fullText) return;
      
      if (fullText.style.display === 'none') {
        shortText.style.display = 'none';
        fullText.style.display = 'inline';
        link.textContent = 'Read Less';
      } else {
        shortText.style.display = 'inline';
        fullText.style.display = 'none';
        link.textContent = 'Read More';
      }
    }

    // Reviews: View more - Load 5 at a time
    (function(){
      var btn = document.getElementById('reviewsMoreBtn');
      if(!btn) return;
      var list = document.getElementById('reviewsList');
      var allHidden = list ? Array.from(list.querySelectorAll('.review-hidden')) : [];
      var currentIndex = 0;
      var batchSize = 5;
      
      function updateButton() {
        var remaining = allHidden.filter(function(el){ return el.style.display === 'none'; }).length;
        if (remaining === 0) {
          btn.style.display = 'none';
        } else {
          btn.textContent = 'View more (' + remaining + ' more)';
        }
      }
      
      btn.addEventListener('click', function(){
        // Show next batch of 5 reviews
        var toShow = allHidden.filter(function(el){ return el.style.display === 'none'; }).slice(0, batchSize);
        toShow.forEach(function(el){ 
          el.style.display = ''; 
          el.classList.remove('review-hidden');
        });
        updateButton();
      });
    })();
  </script>

  <!-- Wishlist Count Script -->
  <script>
    // Fetch and update wishlist count
    async function updateWishlistCount() {
      try {
        const response = await fetch('/api/wishlist/count');
        const data = await response.json();
        const badge = document.getElementById('wishlistBadge');
        if (badge) {
          const count = (data && typeof data.count !== 'undefined') ? data.count : 0;
          badge.textContent = count;
          badge.style.display = 'flex';
        }
      } catch (error) {
        const badge = document.getElementById('wishlistBadge');
        if (badge) {
          badge.textContent = '0';
          badge.style.display = 'flex';
        }
        console.error('Error fetching wishlist count:', error);
      }
    }

    // Navigate to product function for clickable cart items
    function navigateToProduct(event, productId) {
      // Don't navigate if clicking on buttons
      if (event.target.closest('button') || event.target.closest('a')) {
        return;
      }
      window.location.href = `/product/${productId}`;
    }

    // Wishlist button toggle
    function toggleWishlist(productId) {
      const btn = document.getElementById('wishlistBtn');
      const isInWishlist = btn.getAttribute('data-in') === '1';
      
      if (isInWishlist) {
        // Remove from wishlist
        removeFromWishlist(productId);
      } else {
        // Add to wishlist
        addToWishlist(productId);
      }
    }
    
    function addToWishlist(productId) {
      const xhr = new XMLHttpRequest();
      xhr.open('POST', '/wishlist/add', true);
      xhr.setRequestHeader('Content-Type', 'application/json');
      xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
      
      xhr.onload = function() {
        if (xhr.status === 401) {
          // Not logged in - redirect to login
          showToast('Please log in to add items to wishlist', 'info');
          setTimeout(() => {
            window.location.href = '/login';
          }, 1000);
        } else if (xhr.status === 200) {
          try {
            const data = JSON.parse(xhr.responseText);
            if (data.success) {
              // Update button state
              const btn = document.getElementById('wishlistBtn');
              btn.setAttribute('data-in', '1');
              btn.classList.add('active');
              btn.querySelector('i').className = 'fas fa-heart';
              showToast('Added to wishlist', 'success');
              updateWishlistCount();
            } else {
              showToast(data.error || 'Error adding to wishlist', 'error');
            }
          } catch (e) {
            console.error('Error parsing response:', e);
            showToast('Error adding to wishlist', 'error');
          }
        } else {
          showToast('Error adding to wishlist', 'error');
        }
      };
      
      xhr.onerror = function() {
        showToast('Error adding to wishlist', 'error');
      };
      
      xhr.send(JSON.stringify({ product_id: parseInt(productId) }));
    }
    
    function removeFromWishlist(productId) {
      const xhr = new XMLHttpRequest();
      xhr.open('POST', '/wishlist/remove', true);
      xhr.setRequestHeader('Content-Type', 'application/json');
      xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
      
      xhr.onload = function() {
        if (xhr.status === 200) {
          try {
            const data = JSON.parse(xhr.responseText);
            if (data.success) {
              // Reload immediately without toast
              location.reload();
            } else {
              showToast(data.error || 'Error removing from wishlist', 'error');
            }
          } catch (e) {
            console.error('Error parsing response:', e);
            showToast('Error removing from wishlist', 'error');
          }
        } else {
          showToast('Error removing from wishlist', 'error');
        }
      };
      
      xhr.onerror = function() {
        showToast('Error removing from wishlist', 'error');
      };
      
      xhr.send(JSON.stringify({ product_id: parseInt(productId) }));
    }
    
    // Update count on page load
    document.addEventListener('DOMContentLoaded', function() {
      updateWishlistCount();
    });


  </script>

  <!-- Global Loading JavaScript -->
  <script src="{{ url_for('static', filename='js/global-loading.js') }}"></script>
</body>
</html>
